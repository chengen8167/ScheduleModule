<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­è¡¨æ›ç­æ¨¡æ“¬å™¨ - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007AFF; --danger: #ff4d4f; --safe: #2e7d32; --bg: #f0f2f5; --warn: #faad14; }
        body { font-family: -apple-system, "PingFang TC", sans-serif; margin: 0; background: var(--bg); color: #333; font-size: 14px; }
        
        /* é ‚éƒ¨é…ç½®å€ */
        .config-box { background: #fff; padding: 15px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .input-group { display: flex; flex-wrap: wrap; gap: 10px; max-width: 1200px; margin: 0 auto; align-items: center; }
        .file-input-wrapper { background: #f8f9fa; padding: 8px; border-radius: 6px; border: 1px dashed #ccc; font-size: 12px; flex: 1; min-width: 200px; }
        input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 6px; width: 100px; font-weight: bold; text-align: center; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        /* æœˆæ›†å®¹å™¨ */
        #calendar-container { max-width: 1200px; margin: 15px auto; padding: 0 10px; }
        .header-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: white; padding: 10px; border-radius: 8px; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; table-layout: fixed; }
        th { background: #f8f9fa; padding: 10px; border: 1px solid #eee; font-size: 13px; }
        td { border: 1px solid #eee; padding: 8px; vertical-align: top; height: 180px; transition: background 0.2s; }

        /* éŸ¿æ‡‰å¼ï¼šæ‰‹æ©Ÿç‰ˆè®Šåˆ—è¡¨ */
        @media (max-width: 768px) {
            table, thead, tbody, tr, th, td { display: block; }
            thead { display: none; }
            td { height: auto; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #eee; }
            td.empty { display: none; }
        }

        /* æ ¸å¿ƒå…ƒä»¶æ¨£å¼ */
        .conflict-cell { border: 2px solid var(--danger) !important; background: #fff1f0 !important; }
        .date-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .date-num { font-size: 1.2em; font-weight: bold; }
        .orig-tag { font-size: 10px; color: #888; background: #eee; padding: 2px 4px; border-radius: 4px; }
        
        .shift-select { width: 100%; padding: 8px; border: 2px solid #d0e7ff; background: #e7f3ff; color: #1877f2; border-radius: 8px; font-weight: bold; font-size: 16px; margin: 5px 0; outline: none; }
        
        .warning-tag { color: var(--danger); font-size: 11px; font-weight: bold; display: block; margin-top: 2px; }
        
        /* å°æ–¹åå–®å¡ç‰‡ */
        .names-list { margin-top: 8px; border-top: 1px dotted #ddd; padding-top: 5px; }
        .person-card { padding: 4px 6px; border-radius: 4px; margin-bottom: 4px; font-size: 12px; border-left: 3px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .can-swap { border-left-color: var(--safe); background: #f6ffed; }
        .cannot-swap { border-left-color: var(--danger); background: #fff1f0; }
        .err-label { font-size: 10px; color: white; background: var(--danger); padding: 0px 3px; border-radius: 3px; }
    </style>
</head>
<body>

<div class="config-box">
    <div class="input-group">
        <div class="file-input-wrapper">
            Excel æˆ– HTML å­˜æª”: <input type="file" id="uploadAll" accept=".xlsx, .xls, .html">
        </div>
        <input type="text" id="empId" value="A022994" placeholder="å·¥è™Ÿ">
        <button onclick="run()">åŸ·è¡Œæ¨¡æ“¬</button>
    </div>
</div>

<div id="calendar-container">
    <div class="header-info">
        <div id="displayTitle" style="font-size: 1.2em; font-weight: bold;">è«‹è¼‰å…¥è³‡æ–™</div>
        <div id="displayUser" style="color: var(--primary); font-weight: bold;"></div>
    </div>
    <div id="calendarArea"></div>
</div>

<script>
    // 1. ç­åˆ¥æ™‚é–“æ•¸æ“šå®šç¾©
    const SHIFT_DB = {
        "E159G": ["05:15","14:45"], "E159J": ["05:15","15:00"], "E15XA": ["05:15","15:15"],
        "F00XA": ["06:00","16:00"], "F308A": ["06:30","14:30"], "F309G": ["06:30","16:00"], "F30XA": ["06:30","16:30"],
        "G008A": ["07:00","15:00"], "G009A": ["07:00","16:00"], "G158A": ["07:15","15:15"], "G308A": ["07:30","15:30"],
        "J00XA": ["10:00","20:00"], "J308A": ["10:30","18:30"], "K008A": ["11:00","19:00"], "L008A": ["12:00","20:00"], 
        "N008A": ["14:00","22:00"], "N009A": ["14:00","23:00"], "N009G": ["14:00","23:30"], "N308A": ["14:30","22:30"],
        "N309A": ["14:30","23:30"], "N30XA": ["14:30","00:30"], "O008A": ["15:00","23:00"], "O308A": ["15:30","23:30"],
        "O309A": ["15:30","00:30"], "O309G": ["15:30","00:45"], "O30XA": ["15:30","01:30"], "TRN": ["08:30","17:30"]
    };
    const OFF_LIST = ['AL', 'D1', 'D2', 'D2A', 'D3', 'D3X', 'LEV', 'ä¼‘', ''];

    // 2. å…¨åŸŸç‹€æ…‹
    let state = { master: {}, personal: {}, orig: {}, sim: {}, year: 2024, month: 1, userName: "", targetId: "A022994" };

    // 3. æ ¸å¿ƒé‹ç®—å‡½æ•¸
    function getTime(s) {
        if (!s) return null;
        const key = s.toUpperCase().split('/')[0];
        return SHIFT_DB[key] || null;
    }

    function isOff(s) { return !s || OFF_LIST.includes(s.toUpperCase()) || !getTime(s); }

    function getRest(pre, nxt) {
        const p = getTime(pre), n = getTime(nxt);
        if (!p || !n) return 24;
        const [pH, pM] = p[1].split(':').map(Number);
        const [nH, nM] = n[0].split(':').map(Number);
        return ((nH + 24) * 60 + nM - (pH * 60 + pM)) / 60;
    }

    function checkLegality(schedule, d) {
        const rPre = getRest(schedule[d-1], schedule[d]);
        const rNxt = getRest(schedule[d], schedule[d+1]);
        let streak = 0;
        for (let i = d; i >= 1; i--) { if (!isOff(schedule[i])) streak++; else break; }
        for (let i = d + 1; i <= 31; i++) { if (!isOff(schedule[i])) streak++; else break; }
        return { restErr: rPre < 11 || rNxt < 11, streakErr: streak > 6, rVal: Math.min(rPre, rNxt), sVal: streak };
    }

    // 4. æª”æ¡ˆè®€å–é‚è¼¯ (åˆ¤æ–· Excel æˆ– HTML)
    document.getElementById('uploadAll').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        state.targetId = document.getElementById('empId').value.trim().toUpperCase();

        if (file.name.endsWith('.html')) {
            const reader = new FileReader();
            reader.onload = (ev) => parseHTMLData(ev.target.result);
            reader.readAsText(file);
        } else {
            const reader = new FileReader();
            reader.onload = (ev) => parseExcelData(ev.target.result);
            reader.readAsArrayBuffer(file);
        }
    };

    function parseExcelData(buffer) {
        const sheet = XLSX.read(new Uint8Array(buffer), {type:'array'}).Sheets;
        const rows = XLSX.utils.sheet_to_json(sheet[Object.keys(sheet)[0]], {header:1, defval:""});
        const ym = String(rows[4][0]).match(/\d+/g);
        state.year = ym[0]; state.month = ym[1]-1;
        
        let dayCols = {};
        rows[5].forEach((c, i) => { if(!isNaN(parseInt(c))) dayCols[parseInt(c)] = i; });
        
        processRows(rows, (r) => r[2], (r, d) => r[dayCols[d]], (r) => String(r[3]).trim().toUpperCase());
        alert("Excel è§£ææˆåŠŸ");
        run();
    }

    function parseHTMLData(htmlText) {
        const doc = new DOMParser().parseFromString(htmlText, 'text/html');
        const rows = Array.from(doc.querySelectorAll('tr'));
        processRows(rows, (r) => r.querySelectorAll('td')[2]?.innerText, (r, d) => r.querySelectorAll('td')[d+3]?.innerText, (r) => r.querySelectorAll('td')[3]?.innerText.trim().toUpperCase());
        alert("HTML ç¶²é å­˜æª”è§£ææˆåŠŸ");
        run();
    }

    function processRows(rows, getName, getShift, getId) {
        state.master = {}; state.personal = {};
        rows.forEach(r => {
            const id = getId(r);
            const name = getName(r);
            if (!id || !name) return;
            state.personal[name] = { id: id };
            for(let d=1; d<=31; d++) {
                const s = (getShift(r, d) || "").trim();
                state.personal[name][d] = s;
                if(s && isNaN(s)) {
                    if(!state.master[d]) state.master[d] = {};
                    if(!state.master[d][s]) state.master[d][s] = [];
                    state.master[d][s].push(name);
                }
            }
        });
    }

    function run() {
        let userEntry = Object.values(state.personal).find(p => p.id === state.targetId);
        if(!userEntry) return alert("æŸ¥ç„¡å·¥è™Ÿï¼š" + state.targetId);
        state.userName = Object.keys(state.personal).find(k => state.personal[k].id === state.targetId);
        document.getElementById('displayTitle').innerText = `${state.year}å¹´ ${state.month + 1}æœˆ`;
        document.getElementById('displayUser').innerText = `ğŸ‘¤ ${state.userName}`;
        for(let d=1; d<=31; d++) { state.orig[d] = userEntry[d] || ""; state.sim[d] = state.orig[d]; }
        render();
    }

    // 5. æ¸²æŸ“è¦–çª—
    function render() {
        const last = new Date(state.year, state.month + 1, 0).getDate();
        const startDay = new Date(state.year, state.month, 1).getDay();
        let html = `<table><thead><tr><th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr></thead><tbody><tr>`;
        
        for(let i=0; i<startDay; i++) html += `<td class="empty"></td>`;
        
        for(let d=1; d<=last; d++) {
            if((startDay+d-1)%7===0 && d!==1) html += `</tr><tr>`;
            const res = checkLegality(state.sim, d);
            const isErr = res.restErr || res.streakErr;
            
            html += `<td class="${isErr ? 'conflict-cell' : ''}">
                <div class="date-header">
                    <span class="date-num">${d}</span>
                    <span class="orig-tag">åŸ: ${state.orig[d]||'ä¼‘'}</span>
                </div>
                <select class="shift-select" onchange="state.sim[${d}]=this.value; render();">
                    <option value="">(ä¼‘)</option>
                    ${state.master[d] ? Object.keys(state.master[d]).sort().map(s => `<option value="${s}" ${s===state.sim[d]?'selected':''}>${s}</option>`).join('') : ''}
                </select>
                ${res.restErr ? `<span class="warning-tag">âš ï¸ ä¼‘æ¯ä¸è¶³ (${res.rVal.toFixed(1)}h)</span>` : ''}
                ${res.streakErr ? `<span class="warning-tag">âš ï¸ é€£ä¸Šç­ ${res.sVal} å¤©</span>` : ''}
                <div class="names-list">${getSwapList(d, state.sim[d])}</div>
            </td>`;
        }
        document.getElementById('calendarArea').innerHTML = html + `</tr></tbody></table>`;
    }

    function getSwapList(d, targetShift) {
        if(isOff(targetShift) || !state.master[d] || !state.master[d][targetShift]) return "";
        const myOriginal = state.orig[d];

        return state.master[d][targetShift].map(other => {
            if(other === state.userName) return "";
            let otherSched = {...state.personal[other]};
            otherSched[d] = myOriginal;
            const res = checkLegality(otherSched, d);
            const canSwap = !res.restErr && !res.streakErr;

            return `<div class="person-card ${canSwap ? 'can-swap' : 'cannot-swap'}">
                <span>${canSwap ? 'âœ…' : 'âŒ'} ${other}</span>
                ${!canSwap ? `<span class="err-label">${res.restErr?'ä¼‘ä¸è¶³':'é€£ç­'}</span>` : ''}
            </div>`;
        }).join('');
    }
</script>
</body>
</html>
