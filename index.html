<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­è¡¨æ¨¡æ“¬å™¨ - éŒ¯èª¤åŸå› æ˜ç´°ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007AFF; --danger: #ff4d4f; --safe: #2e7d32; --bg: #f0f2f5; --selected: #fff9c4; --gold: #d4a017; }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); font-size: 14px; }
        .config-box { background: #fff; padding: 12px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .row-group { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
        .batch-panel { background: #fffbe6; padding: 15px; border-radius: 12px; border: 2px solid #ffe58f; margin-bottom: 10px; display: none; }
        .btn-execute { background: var(--danger); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 900; font-size: 16px; cursor: pointer; width: 100%; margin-top: 10px; }
        #calendarArea { display: grid; gap: 8px; padding: 8px; }
        .mode-pc { grid-template-columns: repeat(7, 1fr); }
        .mode-mobile { grid-template-columns: 1fr; }
        .day-card { background: white; border-radius: 10px; padding: 10px; border: 2px solid transparent; min-height: 80px; transition: 0.2s; cursor: pointer; }
        .day-card.selected { border-color: var(--gold); background: var(--selected); }
        .date-label { display: flex; justify-content: space-between; font-weight: 800; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .person-item { padding: 6px 8px; border-radius: 4px; margin-top: 4px; font-size: 11px; border-left: 3px solid #ccc; background: #f9f9f9; display: flex; flex-direction: column; gap: 2px; }
        .perfect-match { border-left-color: var(--gold); background: #fffdf0; font-weight: bold; border-left-width: 5px; flex-direction: row; justify-content: space-between; align-items: center; }
        .is-error { opacity: 0.7; color: #555; }
        .btn-collapse { width: 100%; border: none; background: #eee; color: #666; font-size: 10px; padding: 8px; border-radius: 4px; cursor: pointer; margin-top: 8px; }
        .error-tag-list { display: flex; flex-wrap: wrap; gap: 2px; margin-top: 2px; }
        .error-tag { font-size: 9px; background: #fff1f0; color: #cf1322; padding: 0px 4px; border-radius: 3px; border: 1px solid #ffa39e; }
    </style>
</head>
<body>

<div class="config-box">
    <div class="row-group">
        <input type="file" id="xlsxIn" accept=".xlsx" style="flex:1;">
        <input type="text" id="targetId" value="A022994" style="width:80px; text-align:center; padding:5px; border:1px solid #ccc; border-radius:4px;">
        <button onclick="changeView('pc')">ğŸ’»</button>
        <button onclick="changeView('mobile')">ğŸ“±</button>
        <button onclick="initData()" style="background:var(--safe); color:white; border:none; padding:8px 15px; border-radius:8px; font-weight:bold;">åˆ†æç­è¡¨</button>
    </div>
    <div id="batchPanel" class="batch-panel">
        <div style="font-weight:bold; color:#856404;">ğŸ“… å·²é¸é€£çºŒå€é–“ï¼š<span id="selText">0</span> å¤©</div>
        <div style="margin-top:8px; display:flex; align-items:center; gap:10px;">
            <span>ç›®æ¨™ç­åˆ¥ï¼š</span>
            <select id="shiftSel" onchange="renderUI()" style="padding:6px; flex:1; border-radius:5px; border:2px solid var(--primary);"></select>
        </div>
        <button class="btn-execute" onclick="executeBatch()">åŸ·è¡Œæ‰¹æ¬¡å°èª¿</button>
    </div>
</div>

<div id="calendarArea" class="mode-pc"></div>

<script>
    const TIME_TABLE = { "E159G": ["05:15","14:45"], "F30XA": ["06:30","16:30"], "G009A": ["07:00","16:00"], "J00XA": ["10:00","20:00"], "N008A": ["14:00","22:00"], "N30XA": ["14:30","00:30"], "O30XA": ["15:30","01:30"], "D1": ["09:00","18:00"] };
    let state = { master: {}, personal: {}, dayKeys: [], selectedDays: [], mode: 'pc', expanded: {}, targetPrefix: "" };

    function changeView(m) { state.mode = m; renderUI(); }
    function toM(t) { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; }
    
    function checkSafe(pre, cur, nxt) {
        const p = TIME_TABLE[pre?.split('/')[0]], c = TIME_TABLE[cur?.split('/')[0]], n = TIME_TABLE[nxt?.split('/')[0]];
        if(!c) return true;
        let ok = true;
        if(p) ok = ok && ((toM(c[0]) + 1440) - toM(p[1])) >= 660; 
        if(n) ok = ok && ((toM(n[0]) + 1440) - toM(c[1])) >= 660;
        return ok;
    }

    async function initData() {
        const f = document.getElementById('xlsxIn').files[0];
        if(!f) return;
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, {cellStyles: true});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet, {header:1});
        let hIdx = data.findIndex(r => r.includes("å“¡å·¥ç·¨è™Ÿ"));
        state.dayKeys = [];
        data[hIdx].forEach(c => { if(String(c).includes("/")) state.dayKeys.push(c); });
        state.personal = {}; state.master = {}; state.expanded = {}; 
        for(let i = hIdx + 1; i < data.length; i++){
            const name = String(data[i][2]||"").trim(), id = String(data[i][1]||"").trim().toUpperCase();
            if(!id || id === "ç¸½è¨ˆ") continue;
            state.personal[name] = { id, schedule: {} };
            state.dayKeys.forEach(d => {
                const cell = sheet[XLSX.utils.encode_cell({r:i, c:data[hIdx].indexOf(d)})];
                const val = cell ? String(cell.v).trim() : "D1";
                let hex = (cell?.s?.fill?.fgColor?.rgb || "").slice(-6).toUpperCase();
                state.personal[name].schedule[d] = { text: val, isForb: ['FFFF00','FFFFE0','FFC0CB','FF00FF','0000FF','1E88E5'].includes(hex) };
                const p = val.charAt(0).toUpperCase();
                if(!state.master[d]) state.master[d] = {};
                if(!state.master[d][p]) state.master[d][p] = [];
                state.master[d][p].push({ name, text: val });
            });
        }
        renderUI();
    }

    function toggleSelect(d) {
        const currentIdx = state.dayKeys.indexOf(d);
        if (state.selectedDays.length > 0) {
            const indices = state.selectedDays.map(day => state.dayKeys.indexOf(day)).sort((a,b)=>a-b);
            const minIdx = indices[0], maxIdx = indices[indices.length - 1];
            if (state.selectedDays.includes(d)) {
                state.selectedDays.splice(state.selectedDays.indexOf(d), 1);
            } else if (currentIdx === minIdx - 1 || currentIdx === maxIdx + 1) {
                state.selectedDays.push(d);
            } else {
                state.selectedDays = [d];
            }
        } else { state.selectedDays.push(d); }
        
        if(state.selectedDays.length > 0) {
            document.getElementById('batchPanel').style.display = 'block';
            document.getElementById('selText').innerText = state.selectedDays.length;
            let sets = new Set();
            state.selectedDays.forEach(day => Object.keys(state.master[day]||{}).forEach(p => sets.add(p)));
            let opt = '<option value="">(åˆå§‹) é¡¯ç¤ºåŒç­åˆ¥åå–®</option>';
            Array.from(sets).sort().forEach(p => opt += `<option value="${p}">${p} ç­</option>`);
            document.getElementById('shiftSel').innerHTML = opt;
        } else { document.getElementById('batchPanel').style.display = 'none'; }
        renderUI();
    }

    function toggleExpand(e, d) {
        e.stopPropagation();
        state.expanded[d] = !state.expanded[d];
        renderUI();
    }

    function executeBatch() {
        const me = Object.keys(state.personal).find(n => state.personal[n].id === document.getElementById('targetId').value.toUpperCase());
        if(!state.bestMatch) return alert("ç„¡å…¨å¯æ›äººé¸ã€‚");
        state.selectedDays.forEach(d => {
            const m = state.personal[me].schedule[d].text, h = state.personal[state.bestMatch].schedule[d].text;
            state.personal[me].schedule[d].text = h; state.personal[state.bestMatch].schedule[d].text = m;
        });
        alert(`å°èª¿å®Œæˆï¼èˆ‡ ${state.bestMatch} é€£çºŒå°èª¿æˆåŠŸã€‚`);
        state.selectedDays = []; renderUI();
    }

    function renderUI() {
        const area = document.getElementById('calendarArea');
        area.className = state.mode === 'pc' ? 'mode-pc' : 'mode-mobile';
        const myName = Object.keys(state.personal).find(n => state.personal[n].id === document.getElementById('targetId').value.toUpperCase());
        if(!myName) return;
        state.targetPrefix = document.getElementById('shiftSel')?.value || "";

        const selectedIndices = state.selectedDays.map(d => state.dayKeys.indexOf(d)).sort((a,b)=>a-b);
        const firstIdx = selectedIndices[0], lastIdx = selectedIndices[selectedIndices.length - 1];

        // æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—æ‰€æœ‰äººåœ¨ã€Œå·²é¸å€é–“ã€çš„ç‹€æ…‹æ˜ç´°
        let userStats = {};
        if(state.selectedDays.length > 0) {
            Object.keys(state.personal).forEach(n => {
                if(n === myName) return;
                userStats[n] = { errors: [], totalMatch: 0 };
                
                state.selectedDays.forEach(d => {
                    const myS = state.personal[myName].schedule[d], cS = state.personal[n].schedule[d];
                    const dIdx = state.dayKeys.indexOf(d), target = state.targetPrefix || myS.text.charAt(0).toUpperCase();
                    
                    const isMatchPrefix = cS.text.charAt(0).toUpperCase() === target;
                    let safe = checkSafe(state.personal[n].schedule[state.dayKeys[dIdx-1]]?.text, myS.text, state.personal[n].schedule[state.dayKeys[dIdx+1]]?.text);
                    if (dIdx === firstIdx) safe = safe && checkSafe(state.personal[n].schedule[state.dayKeys[dIdx-1]]?.text, myS.text, null);
                    if (dIdx === lastIdx) safe = safe && checkSafe(null, myS.text, state.personal[n].schedule[state.dayKeys[dIdx+1]]?.text);

                    if (isMatchPrefix && !cS.isForb && safe) {
                        userStats[n].totalMatch++;
                    } else {
                        let reason = !isMatchPrefix ? "ç­åˆ¥ä¸ç¬¦" : (!safe ? "ä¼‘æ¯ä¸è¶³" : "èº«åˆ†æ’é™¤");
                        userStats[n].errors.push(`${d.split('/')[1]}æ—¥${reason}(${cS.text})`);
                    }
                });
            });
        }

        const commonIntersection = Object.keys(userStats).filter(n => userStats[n].totalMatch === state.selectedDays.length);
        state.bestMatch = commonIntersection[0] || null;

        area.innerHTML = state.dayKeys.map(d => {
            const isSelectedDay = state.selectedDays.includes(d);
            const isExp = !!state.expanded[d], myS = state.personal[myName].schedule[d];
            const currT = state.targetPrefix || myS.text.charAt(0).toUpperCase();
            
            let topHTML = "", otherHTML = "", otherCount = 0;

            Object.keys(state.personal).forEach(n => {
                if(n === myName) return;
                const cS = state.personal[n].schedule[d];
                const isTop = isSelectedDay && commonIntersection.includes(n);
                const isMatchPrefix = cS.text.charAt(0).toUpperCase() === currT;

                if (isTop || isMatchPrefix) {
                    if(isTop) {
                        topHTML += `<div class="person-item perfect-match">
                            <span>${n} <small>(${cS.text})</small></span>
                            <b style="color:var(--gold)">âœ¨</b>
                        </div>`;
                    } else {
                        otherCount++;
                        if(isExp) {
                            let errorTags = isSelectedDay ? userStats[n].errors.map(err => `<span class="error-tag">${err}</span>`).join('') : '';
                            otherHTML += `<div class="person-item is-error">
                                <div style="display:flex; justify-content:space-between;">
                                    <span>${n} <small>(${cS.text})</small></span>
                                </div>
                                <div class="error-tag-list">${errorTags}</div>
                            </div>`;
                        }
                    }
                }
            });

            return `
                <div class="day-card ${isSelectedDay?'selected':''}" onclick="toggleSelect('${d}')">
                    <div class="date-label">
                        ${d.split('/')[1]}
                        <span>${myS.text} ${isSelectedDay && state.targetPrefix ? `<span style="color:red">âœ ${currT}</span>`:''}</span>
                    </div>
                    <div style="margin-top:5px;">
                        ${topHTML}
                        <button class="btn-collapse" onclick="toggleExpand(event, '${d}')">
                            ${isExp ? 'æ”¶èµ·åå–® â†‘' : `å±•é–‹å…¶é¤˜äººé¸ (${otherCount}) â†“`}
                        </button>
                        <div style="margin-top:4px;">${otherHTML}</div>
                    </div>
                </div>
            `;
        }).join('');
    }
</script>
</body>
</html>
