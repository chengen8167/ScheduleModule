<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­è¡¨å°å¹«æ‰‹ - v3.10.0 Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        :root { --primary: #007AFF; --danger: #ff4d4f; --safe: #2e7d32; --bg: #f0f2f5; --selected: #fff9c4; --gold: #d4a017; --white: #ffffff; }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); font-size: 14px; padding-bottom: 250px; }
        .config-box { background: var(--white); padding: 12px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .row-group { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
        .btn-analyze { background: var(--safe); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-analyze:disabled { background: #ccc; cursor: not-allowed; }
        
        #calendarArea { display: grid; gap: 8px; padding: 8px; }
        .mode-pc { grid-template-columns: repeat(7, 1fr); }
        .mode-mobile { grid-template-columns: 1fr; }
        
        .day-card { background: var(--white); border-radius: 10px; padding: 10px; border: 2px solid transparent; min-height: 80px; cursor: pointer; }
        .day-card.selected { border-color: var(--gold); background: var(--selected); }
        .date-label { display: flex; justify-content: space-between; font-weight: 800; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .group-header { font-size: 10px; color: #999; margin: 8px 0 2px 2px; border-top: 1px dashed #eee; padding-top: 4px; }
        .person-item { padding: 6px 8px; border-radius: 4px; margin-top: 4px; font-size: 12px; border-left: 3px solid #ccc; background: #f9f9f9; display: flex; flex-direction: column; }
        .perfect-match { border-left-color: var(--gold); background: #fffdf0; font-weight: bold; border-left-width: 5px; }
        .perfect-match.target-selected { background: #fff3cd; border: 2px solid var(--gold); }
        .colored-name { font-weight: 900; } 
        
        .error-tag { font-size: 9px; background: #fff1f0; color: #cf1322; padding: 1px 4px; border-radius: 3px; border: 1px solid #ffa39e; margin-right: 2px; display: inline-block; }
        .batch-panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; background: rgba(255, 251, 230, 0.98); backdrop-filter: blur(12px); padding: 15px; border-radius: 16px; border: 2px solid #ffe58f; box-shadow: 0 -4px 25px rgba(0,0,0,0.18); z-index: 2000; display: none; }
        .summary-box { background: #fff; border-radius: 8px; padding: 10px; margin-top: 10px; font-size: 12px; border: 1px solid #ddd; max-height: 120px; overflow-y: auto; white-space: pre-wrap; }
    </style>
</head>
<body class="mode-pc">

<div class="config-box">
    <div class="row-group">
        <strong style="color:var(--primary);">ç­è¡¨å°å¹«æ‰‹ v3.10.0</strong>
        <input type="file" id="xlsxIn" accept=".xlsx" style="flex:1;">
        <input type="text" id="targetId" value="A022994" style="width:80px; text-align:center;">
        <button onclick="initData()" id="btnAnalyze" class="btn-analyze">åˆ†æ</button>
    </div>
</div>

<div id="batchPanel" class="batch-panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:bold;">ğŸ“… æ‰¹é‡æ›ç­è¨­å®š</span>
        <button onclick="closePanel()" style="background:none; border:none; font-size:24px;">&times;</button>
    </div>
    <select id="shiftSel" onchange="renderUI()" style="width:100%; padding:10px; margin-top:10px; border-radius:8px; border:2px solid var(--primary); font-weight:bold;"></select>
    <div id="selectedTargetDisplay" style="font-weight:bold; color:var(--danger); margin-top: 10px;">è«‹é»é¸ä¸‹æ–¹ âœ¨ äººé¸</div>
    <div id="changeSummary" class="summary-box"></div>
    <button style="background:var(--danger); color:white; border:none; padding:12px; border-radius:8px; font-weight:900; width:100%; margin-top:10px;" onclick="executeBatch()">è¤‡è£½æ‘˜è¦è¨Šæ¯</button>
</div>

<div id="calendarArea"></div>

<script>
    const TIME_TABLE = {
        "E159g": ["05:15", "14:45"], "E159j": ["05:15", "15:00"], "E15Xa": ["05:15", "15:15"],
        "F00Xa": ["06:00", "16:00"], "F308a": ["06:30", "14:30"], "F309g": ["06:30", "16:00"], "F30Xa": ["06:30", "16:30"],
        "G008a": ["07:00", "15:00"], "G009a": ["07:00", "16:00"], "G158a": ["07:15", "15:15"], "G308a": ["07:30", "15:30"],
        "J00Xa": ["10:00", "20:00"], "J308a": ["10:30", "18:30"], "K008a": ["11:00", "19:00"], "L008a": ["12:00", "20:00"],
        "N008a": ["14:00", "22:00"], "N009a": ["14:00", "23:00"], "N009g": ["14:00", "23:30"], "N308a": ["14:30", "22:30"], "N309a": ["14:30", "23:30"], "N30Xa": ["14:30", "00:30"],
        "O008a": ["15:00", "23:00"], "O308a": ["15:30", "23:30"], "O309a": ["15:30", "00:30"], "O309g": ["15:30", "00:45"], "O30Xa": ["15:30", "01:30"],
        "TRN": ["08:30", "17:30"], "T6": ["09:00", "18:00"]
    };

    const EXCLUDE_HEX = ["FFFF99", "FF99CC", "99CCFF", "CCFFFF", "FFCC66"];
    let state = { personal: {}, dayKeys: [], selectedDays: [], expanded: {}, chosenTarget: null };

    function toM(t) { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; }
    function cleanShift(txt) { return String(txt || "").replace(/[\r\n]+/g, "").split('/')[0].split('@')[0].trim(); }
    function getCellVal(c) { 
        if (!c) return "";
        let v = c.value;
        if (v && typeof v === 'object' && v.text) return String(v.text).trim();
        return String(v || "").trim();
    }

    function isConflicting(preTxt, curTxt) {
        const pClean = cleanShift(preTxt), cClean = cleanShift(curTxt);
        const p = TIME_TABLE[pClean], c = TIME_TABLE[cClean];
        if(!p || !c) return false;
        let pEnd = toM(p[1]); if (pEnd < toM(p[0])) pEnd += 1440; 
        const cStart = toM(c[0]) + 1440; return (cStart - pEnd) < 660; 
    }

    async function initData() {
        const fileInput = document.getElementById('xlsxIn');
        const btn = document.getElementById('btnAnalyze');
        if(!fileInput.files[0]) return alert("è«‹å…ˆé¸æ“‡ Excel æª”æ¡ˆ");
        
        btn.disabled = true;
        btn.innerText = "è®€å–ä¸­...";
        
        try {
            const workbook = new ExcelJS.Workbook();
            const arrayBuffer = await fileInput.files[0].arrayBuffer();
            await workbook.xlsx.load(arrayBuffer);
            const worksheet = workbook.getWorksheet(1);
            
            state.personal = {}; state.dayKeys = [];
            let hIdx = -1;
            
            worksheet.eachRow((row, rowNum) => {
                if (hIdx === -1) {
                    row.eachCell(c => {
                        if (getCellVal(c).includes("å“¡å·¥ç·¨è™Ÿ")) hIdx = rowNum;
                    });
                }
            });

            if(hIdx === -1) throw new Error("æ‰¾ä¸åˆ°ã€å“¡å·¥ç·¨è™Ÿã€æ¬„ä½");

            const hRow = worksheet.getRow(hIdx);
            hRow.eachCell((cell, colNum) => {
                const val = getCellVal(cell);
                if (val.includes("/")) state.dayKeys.push({ label: val, col: colNum });
            });

            worksheet.eachRow((row, rowNum) => {
                if (rowNum <= hIdx) return;
                const nameCell = row.getCell(3), name = getCellVal(nameCell), id = getCellVal(row.getCell(2)).toUpperCase();
                if (!id || id.includes("ç¸½è¨ˆ")) return;
                
                // è‰²å¡Šéæ¿¾
                const fg = nameCell.fill?.fgColor;
                if (fg?.argb && EXCLUDE_HEX.includes(fg.argb.slice(-6).toUpperCase())) return;

                state.personal[name] = { id, schedule: {} };
                state.dayKeys.forEach(dk => {
                    const cell = row.getCell(dk.col);
                    state.personal[name].schedule[dk.label] = { 
                        text: getCellVal(cell) || "D1", 
                        hex: cell.fill?.fgColor?.argb ? cell.fill.fgColor.argb.slice(-6) : '000000'
                    };
                });
            });

            renderUI();
            btn.innerText = "åˆ†ææˆåŠŸ";
        } catch (e) {
            console.error(e);
            alert("è®€å–å¤±æ•—: " + e.message);
            btn.innerText = "é‡è©¦åˆ†æ";
        } finally {
            btn.disabled = false;
        }
    }

    function renderUI() {
        const area = document.getElementById('calendarArea'), labels = state.dayKeys.map(k => k.label);
        const myName = Object.keys(state.personal).find(n => state.personal[n].id === document.getElementById('targetId').value.toUpperCase());
        if(!myName) return;

        const filterVal = document.getElementById('shiftSel')?.value || "";

        area.innerHTML = labels.map(d => {
            const isSel = state.selectedDays.includes(d), myS = state.personal[myName].schedule[d];
            let perfH = "", conflictH = "", othersCount = 0;
            const activeFilter = filterVal || cleanShift(myS.text).charAt(0).toUpperCase();

            Object.keys(state.personal).forEach(n => {
                if(n === myName) return;
                const cS = state.personal[n].schedule[d], hisBase = cleanShift(cS.text);
                if (!TIME_TABLE[hisBase] || hisBase.charAt(0).toUpperCase() !== activeFilter) return;

                let errors = [];
                state.selectedDays.forEach(sd => {
                    const idx = labels.indexOf(sd), targetShift = state.personal[myName].schedule[sd].text;
                    const pS = state.selectedDays.includes(labels[idx-1]) ? state.personal[myName].schedule[labels[idx-1]].text : state.personal[n].schedule[labels[idx-1]]?.text;
                    const nS = state.selectedDays.includes(labels[idx+1]) ? state.personal[myName].schedule[labels[idx+1]].text : state.personal[n].schedule[labels[idx+1]]?.text;
                    if (isConflicting(pS, targetShift) || isConflicting(targetShift, nS)) errors.push(`${sd.split('/')[1]}æ—¥ä¼‘æ¯ä¸è¶³`);
                });

                const isPerf = isSel && errors.length === 0;
                const item = `<div class="person-item ${isPerf?'perfect-match':''} ${state.chosenTarget===n?'target-selected':''}" onclick="event.stopPropagation(); selectTargetPerson('${n}', ${isPerf})">
                    <div style="display:flex;justify-content:space-between;"><span class="colored-name" style="color:#${cS.hex}">${n} <small>(${hisBase})</small></span>${isPerf?'âœ¨':''}</div>
                    ${isSel && !isPerf && errors.length ? `<div>${[...new Set(errors)].map(e=>`<span class="error-tag">${e}</span>`).join('')}</div>`:''}
                </div>`;

                if (isPerf) perfH += item; else { if(state.expanded[d]) conflictH += item; othersCount++; }
            });

            return `<div class="day-card ${isSel?'selected':''}" onclick="toggleSelect('${d}')">
                <div class="date-label">${d.split('/')[1]}æ—¥ <span>${myS.text.split('\n')[0]}</span></div>
                <div class="group-header">âœ¨ å®Œç¾åŒ¹é…</div>${perfH || '<div style="font-size:9px;color:#ccc;padding:4px;">ç„¡å…¨ç›¸å®¹äººé¸</div>'}
                <div class="group-header">âš ï¸ å…¶ä»–å€™é¸ (${othersCount})</div>${conflictH}
                ${othersCount > 0 ? `<button class="btn-collapse" style="width:100%;margin-top:5px;font-size:10px;" onclick="event.stopPropagation(); state.expanded['${d}']=!state.expanded['${d}']; renderUI();">${state.expanded[d]?'éš±è—':'é¡¯ç¤º'}æ‰€æœ‰</button>` : ''}
            </div>`;
        }).join('');
        updateSummary();
    }

    function toggleSelect(d) {
        if(state.selectedDays.includes(d)) state.selectedDays = state.selectedDays.filter(x=>x!==d);
        else state.selectedDays.push(d);
        state.selectedDays.sort((a,b)=>state.dayKeys.findIndex(k=>k.label===a)-state.dayKeys.findIndex(k=>k.label===b));
        document.getElementById('batchPanel').style.display = state.selectedDays.length ? 'block' : 'none';
        if(state.selectedDays.length) {
            let sets = new Set();
            state.selectedDays.forEach(day => Object.values(state.personal).forEach(p => { 
                const b = cleanShift(p.schedule[day]?.text); if(/^[A-Z]/.test(b)) sets.add(b.charAt(0));
            }));
            let opt = '<option value="">(åˆå§‹:è‡ªå‹•ç¯©é¸)</option>';
            Array.from(sets).sort().forEach(p => opt += `<option value="${p}">${p} ç­</option>`);
            document.getElementById('shiftSel').innerHTML = opt;
        }
        renderUI();
    }

    function selectTargetPerson(n, isPerf) {
        if(!isPerf) { alert("æ­¤äººé¸æœ‰è¡çªï¼Œä¸å»ºè­°é¸æ“‡ã€‚"); return; }
        state.chosenTarget = n;
        document.getElementById('selectedTargetDisplay').innerText = `å·²é¸å®šå°è±¡ï¼š${n} âœ¨`;
        updateSummary();
        renderUI();
    }

    function updateSummary() {
        if(!state.chosenTarget || !state.selectedDays.length) return;
        const myName = Object.keys(state.personal).find(n => state.personal[n].id === document.getElementById('targetId').value.toUpperCase());
        let text = `ã€æ›ç­æ‘˜è¦ã€‘\nå°è±¡ï¼š${state.chosenTarget}\næ—¥æœŸæ˜ç´°ï¼š\n`;
        state.selectedDays.forEach(d => {
            const myS = state.personal[myName].schedule[d].text.split('\n')[0];
            const hisS = state.personal[state.chosenTarget].schedule[d].text.split('\n')[0];
            text += `ğŸ“… ${d}ï¼š${hisS} â†”ï¸ ${myS}\n`;
        });
        document.getElementById('changeSummary').innerText = text;
    }

    function executeBatch() {
        const summary = document.getElementById('changeSummary').innerText;
        if(!summary) return alert("è«‹å…ˆé¸æ“‡æ›ç­å°è±¡");
        navigator.clipboard.writeText(summary).then(() => alert("å·²è¤‡è£½æ‘˜è¦ï¼æ‚¨å¯ä»¥ç›´æ¥è²¼ä¸Šè‡³ Lineã€‚"));
    }

    function closePanel() { state.selectedDays=[]; state.chosenTarget=null; document.getElementById('batchPanel').style.display='none'; renderUI(); }
</script>
</body>
</html>
