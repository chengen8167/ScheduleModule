<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­è¡¨æ¨¡æ“¬å™¨ - é è¨­å·¥è™Ÿç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007AFF; --danger: #ff4d4f; --safe: #2e7d32; --bg: #f0f2f5; --selected: #fff9c4; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); width: 100vw; overflow-x: hidden; }

        .config-box { background: #fff; padding: 12px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        .row-group { display: flex; gap: 8px; width: 100%; align-items: center; }
        .file-input-wrapper { background: #f8f9fa; padding: 8px; border-radius: 8px; border: 1px dashed #ccc; flex: 1; font-size: 12px; }
        input[type="text"] { width: 100px; padding: 8px; border: 1px solid #ccc; border-radius: 8px; text-align: center; font-weight: bold; }
        
        .mode-controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 5px; }
        button { background: var(--primary); color: white; border: none; padding: 10px 5px; border-radius: 8px; font-weight: bold; font-size: 12px; cursor: pointer; }
        button.secondary { background: #6c757d; }
        button.action { background: var(--safe); }

        .batch-bar { background: #fffbe6; padding: 12px; border-radius: 12px; margin-top: 8px; display: none; flex-direction: column; gap: 8px; border: 2px solid #ffe58f; }

        #calendar-container { width: 100%; padding: 10px; }
        .day-card { background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 2px solid transparent; }
        .day-card.selected { border-color: #ffd600; background: var(--selected); }

        .force-table { overflow-x: auto; background: white; padding: 10px; border-radius: 8px; }
        .force-table table { width: 100%; min-width: 1100px; border-collapse: collapse; table-layout: fixed; }
        .force-table td { border: 1px solid #eee; padding: 8px; vertical-align: top; width: 14.28%; }

        .date-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 5px; }
        .date-num { font-size: 1.4em; font-weight: 800; }
        .orig-tag { font-size: 10px; color: #888; background: #f0f0f0; padding: 1px 4px; border-radius: 4px; }
        
        .shift-select { width: 100%; padding: 8px; border: 2px solid var(--primary); background: #fff; border-radius: 6px; font-weight: bold; font-size: 16px; text-align: center; }

        .collapse-btn { 
            width: 100%; background: #eee; color: #666; border: none; padding: 6px; 
            border-radius: 6px; font-size: 11px; margin: 4px 0; 
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }

        .person-card { padding: 6px; border-radius: 6px; margin-top: 5px; border-left: 4px solid #ccc; font-size: 12px; background: #f9f9f9; }
        .can-swap { border-left-color: var(--safe); background: #f6ffed; }
        .cannot-swap { border-left-color: var(--danger); background: #fff1f0; }
        .batch-hero { border: 2px solid var(--safe); background: #eafff0 !important; font-weight: bold; outline: 1px solid var(--safe); }
        
        .target-hint { background: #007AFF; color: white; padding: 2px 6px; border-radius: 6px; font-size: 10px; margin-bottom: 5px; display: block; text-align: center; }
    </style>
</head>
<body>

<div class="config-box">
    <div class="input-group">
        <div class="row-group">
            <div class="file-input-wrapper"><input type="file" id="uploadAll" accept=".xlsx, .xls, .html" style="width:100%"></div>
            <input type="text" id="empId" value="A022994" placeholder="å·¥è™Ÿ">
            <button onclick="run()" class="action">è¼‰å…¥åˆ†æ</button>
        </div>
        <div class="mode-controls">
            <button class="secondary" onclick="setMode('auto')">ğŸŒ“ è‡ªå‹•</button>
            <button class="secondary" onclick="setMode('table')">ğŸ’» é›»è…¦</button>
            <button class="secondary" onclick="setMode('list')">ğŸ“± æ‰‹æ©Ÿ</button>
        </div>
        <div id="batchBar" class="batch-bar">
            <div style="font-size: 12px; font-weight: bold; color: #856404;">æ‰¹æ¬¡æ“ä½œï¼šå·²é¸ <span id="selectedDaysTxt"></span></div>
            <div class="row-group">
                <select id="batchShiftTarget" class="shift-select" style="margin:0; flex:2; font-size:14px;" onchange="render()"></select>
                <button onclick="applyBatch()" style="background:var(--safe); flex:1;">å¥—ç”¨æ›ç­</button>
                <button onclick="clearSelection()" style="background:#6c757d; flex:1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<div id="calendar-container">
    <div id="displayUser" style="margin: 5px 0 10px 5px; font-weight: bold; color: var(--primary);">è«‹å…ˆè®€å…¥ç­è¡¨æª”æ¡ˆ</div>
    <div id="calendarArea"></div>
</div>

<script>
    const SHIFT_DB = { "E159G": ["05:15","14:45"], "E159J": ["05:15","15:00"], "E15XA": ["05:15","15:15"], "F00XA": ["06:00","16:00"], "F308A": ["06:30","14:30"], "F309G": ["06:30","16:00"], "F30XA": ["06:30","16:30"], "G008A": ["07:00","15:00"], "G009A": ["07:00","16:00"], "G158A": ["07:15","15:15"], "G308A": ["07:30","15:30"], "J00XA": ["10:00","20:00"], "J308A": ["10:30","18:30"], "K008A": ["11:00","19:00"], "L008A": ["12:00","20:00"], "N008A": ["14:00","22:00"], "N009A": ["14:00","23:00"], "N009G": ["14:00","23:30"], "N308A": ["14:30","22:30"], "N309A": ["14:30","23:30"], "N30XA": ["14:30","00:30"], "O008A": ["15:00","23:00"], "O308A": ["15:30","23:30"], "O309A": ["15:30","00:30"], "O309G": ["15:30","00:45"], "O30XA": ["15:30","01:30"], "TRN": ["08:30","17:30"] };
    const OFF_LIST = ['AL', 'D1', 'D2', 'D2A', 'D3', 'D3X', 'LEV', 'ä¼‘', ''];
    let state = { master: {}, personal: {}, orig: {}, simPrefix: {}, year: 2026, month: 0, userName: "", targetId: "", selectedDays: [], currentMode: 'auto', collapsedDays: {}, activeBatchDays: [], activeBatchTarget: "" };

    function getTime(s) { if (!s) return null; const key = s.toUpperCase().split('/')[0]; return SHIFT_DB[key] || null; }
    function isOff(s) { if(!s) return true; let up = s.toUpperCase(); return OFF_LIST.includes(up) || up.startsWith('D'); }
    function getRest(pre, nxt) { 
        const p = getTime(pre), n = getTime(nxt); if (!p || !n) return 24; 
        const [pH, pM] = p[1].split(':').map(Number), [nH, nM] = n[0].split(':').map(Number); 
        return ((nH + 24) * 60 + nM - (pH * 60 + pM)) / 60; 
    }
    function checkLegality(schedule, d) { return { restErr: getRest(schedule[d-1], schedule[d]) < 11 || getRest(schedule[d], schedule[d+1]) < 11 }; }

    function setMode(mode) { state.currentMode = mode; render(); }
    function toggleDay(d) {
        const idx = state.selectedDays.indexOf(d);
        if (idx > -1) state.selectedDays.splice(idx, 1); else state.selectedDays.push(d);
        updateBatchBar(); render();
    }
    function updateBatchBar() {
        const bar = document.getElementById('batchBar');
        if (state.selectedDays.length > 0) {
            bar.style.display = 'flex';
            document.getElementById('selectedDaysTxt').innerText = state.selectedDays.sort((a,b)=>a-b).join(', ') + " æ—¥";
            let prefixes = new Set();
            state.selectedDays.forEach(d => { if(state.master[d]) Object.keys(state.master[d]).forEach(p => prefixes.add(p)); });
            let html = '<option value="D">æœå°‹ï¼šä¼‘å‡äººé¸</option>';
            Array.from(prefixes).sort().forEach(p => { if(p!=="D") html += `<option value="${p}">æœå°‹ï¼š${p} ç­äººé¸</option>`; });
            const currentVal = document.getElementById('batchShiftTarget').value;
            document.getElementById('batchShiftTarget').innerHTML = html;
            if(currentVal) document.getElementById('batchShiftTarget').value = currentVal;
        } else { bar.style.display = 'none'; }
    }

    function applyBatch() {
        state.activeBatchTarget = document.getElementById('batchShiftTarget').value;
        state.activeBatchDays = [...state.selectedDays];
        state.activeBatchDays.forEach(d => {
            state.simPrefix[d] = state.activeBatchTarget;
            // è‹¥æ¨¡æ“¬ç­åˆ¥é¡åˆ¥ä¸åŒï¼Œå‰‡ä¸æ‘ºç–Š
            state.collapsedDays[d] = (state.simPrefix[d] === (state.orig[d]?.charAt(0).toUpperCase() || "D"));
        });
        state.selectedDays = [];
        updateBatchBar();
        render();
    }

    function clearSelection() { 
        state.selectedDays = []; state.activeBatchDays = []; state.activeBatchTarget = ""; 
        updateBatchBar(); render(); 
    }
    function toggleCollapse(d) { state.collapsedDays[d] = !state.collapsedDays[d]; render(); }

    document.getElementById('uploadAll').onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            const sheet = XLSX.read(new Uint8Array(ev.target.result), {type:'array'}).Sheets;
            const rows = XLSX.utils.sheet_to_json(sheet[Object.keys(sheet)[0]], {header:1, defval:""});
            
            // è§£ææ—¥æœŸç¯„åœ (æ–°æ ¼å¼é¦–åˆ—)
            const ym = String(rows[0][0]).match(/\d+/g); 
            state.year = ym ? ym[0] : 2026; state.month = ym ? ym[1]-1 : 0;

            // å°‹æ‰¾è¡¨é ­åˆ—èˆ‡æ—¥æœŸå®šä½
            let dCols = {}; 
            const headerRow = rows.find(r => r.some(v => String(v).includes("01/")));
            if(headerRow){
                headerRow.forEach((c, i) => {
                    let dMatch = String(c).match(/\/(\d+)/);
                    let d = dMatch ? parseInt(dMatch[1]) : parseInt(c);
                    if(!isNaN(d) && d >= 1 && d <= 31) dCols[d] = i;
                });
            }

            state.master = {}; state.personal = {};
            rows.forEach(r => {
                const id = String(r[1]||"").trim().toUpperCase(); // Bæ¬„å·¥è™Ÿ
                const name = String(r[2]||"").trim(); // Cæ¬„å§“å
                if (!id || id === "å“¡å·¥ç·¨è™Ÿ" || !name) return;

                state.personal[name] = { id: id };
                for(let d=1; d<=31; d++) {
                    let s = String(r[dCols[d]] || "").trim();
                    state.personal[name][d] = s;
                    if(s) {
                        const p = s.charAt(0).toUpperCase();
                        if(!state.master[d]) state.master[d] = {};
                        if(!state.master[d][p]) state.master[d][p] = [];
                        state.master[d][p].push({ name, actual: s });
                    }
                }
            });
            run(); // è‡ªå‹•æ ¹æ“šé è¨­å·¥è™Ÿè·‘åˆ†æ
        };
        reader.readAsArrayBuffer(file);
    };

    function run() {
        state.targetId = document.getElementById('empId').value.trim().toUpperCase();
        let entry = Object.values(state.personal).find(p => p.id === state.targetId);
        if(!entry) {
             document.getElementById('displayUser').innerText = "âŒ æ‰¾ä¸åˆ°å·¥è™Ÿ " + state.targetId;
             return;
        }
        state.userName = Object.keys(state.personal).find(k => state.personal[k].id === state.targetId);
        document.getElementById('displayUser').innerText = `ğŸ‘¤ ${state.userName} (å·¥è™Ÿ:${state.targetId}) - ${state.year}/${state.month+1}`;
        for(let d=1; d<=31; d++) { 
            state.orig[d] = entry[d] || ""; 
            state.simPrefix[d] = state.orig[d].charAt(0).toUpperCase() || "D";
            state.collapsedDays[d] = true; // é è¨­å…¨éƒ¨æŠ˜ç–Šäººå
        }
        render();
    }

    function render() {
        const last = new Date(state.year, state.month + 1, 0).getDate();
        const startDay = new Date(state.year, state.month, 1).getDay();
        const area = document.getElementById('calendarArea');
        const isTable = state.currentMode === 'table' || (state.currentMode === 'auto' && window.innerWidth > 768);
        const batchTarget = document.getElementById('batchShiftTarget')?.value || "";

        area.className = isTable ? 'force-table' : '';
        let html = isTable ? '<table><tbody><tr>' : '';
        if(isTable) for(let i=0; i<startDay; i++) html += '<td></td>';

        for(let d=1; d<=last; d++) {
            if(isTable && (startDay+d-1)%7===0 && d!==1) html += '</tr><tr>';
            const isSelected = state.selectedDays.includes(d);
            const currentPrefix = state.simPrefix[d];
            const currentSearchTarget = isSelected ? batchTarget : currentPrefix;

            const cardHtml = `
                <div class="day-card ${isSelected?'selected':''}">
                    <div class="date-header" onclick="toggleDay(${d})">
                        <div><span class="date-num">${d}</span> <span class="orig-tag">åŸ:${state.orig[d]||'ä¼‘'}</span></div>
                        <span style="font-size:10px;">${isSelected?'âœ…':'ğŸ”˜'}</span>
                    </div>
                    ${isSelected ? `<span class="target-hint">æ­£åœ¨æœ ${currentSearchTarget || 'ä¼‘'} ç­...</span>` : `
                        <select class="shift-select" onchange="state.simPrefix[${d}]=this.value; state.collapsedDays[${d}]=(this.value === (state.orig[${d}]?.charAt(0).toUpperCase() || 'D')); render();">
                            <option value="D" ${currentPrefix==='D'?'selected':''}>ä¼‘</option>
                            ${state.master[d] ? Object.keys(state.master[d]).sort().map(p => {
                                if(p==='D') return '';
                                return `<option value="${p}" ${p===currentPrefix?'selected':''}>${p} ç­</option>`;
                            }).join('') : ''}
                        </select>
                    `}
                    <div class="names-list">${getSwapList(d, currentSearchTarget)}</div>
                </div>`;
            html += isTable ? `<td>${cardHtml}</td>` : cardHtml;
        }
        area.innerHTML = isTable ? html + '</tr></tbody></table>' : html;
    }

    function getSwapList(day, targetPrefix) {
        let candidates = [];
        const normalizedTarget = (targetPrefix === "D" || !targetPrefix) ? "D" : targetPrefix;

        if(normalizedTarget === "D") {
            Object.keys(state.personal).forEach(n => { 
                if(n !== state.userName && isOff(state.personal[n][day])) candidates.push({name:n, actual:state.personal[n][day]}); 
            });
        } else if(state.master[day] && state.master[day][normalizedTarget]) {
            candidates = state.master[day][normalizedTarget].filter(i => i.name !== state.userName);
        }
        
        const activeDays = state.selectedDays.length > 0 ? state.selectedDays : (state.activeBatchDays.includes(day) ? state.activeBatchDays : [day]);
        const activeTarget = state.selectedDays.length > 0 ? document.getElementById('batchShiftTarget').value : (state.activeBatchDays.includes(day) ? state.activeBatchTarget : targetPrefix);

        const processed = candidates.map(item => {
            let hisSched = {...state.personal[item.name]}; hisSched[day] = state.orig[day];
            const res = checkLegality(hisSched, day);
            let isFullBatchMatch = false;
            
            if (activeDays.length > 1) {
                isFullBatchMatch = activeDays.every(ad => {
                    const shift = (state.personal[item.name][ad] || "").toUpperCase();
                    const match = (activeTarget === "D") ? isOff(shift) : shift.startsWith(activeTarget.toUpperCase());
                    let tempSched = {...state.personal[item.name]};
                    tempSched[ad] = state.orig[ad];
                    return match && !checkLegality(tempSched, ad).restErr;
                });
            } else if (activeDays.length === 1 && targetPrefix !== (state.orig[day]?.charAt(0).toUpperCase() || "D")) {
                isFullBatchMatch = !res.restErr;
            }
            return { ...item, res, isFullBatchMatch };
        });

        const heroes = processed.filter(c => c.isFullBatchMatch);
        const others = processed.filter(c => !c.isFullBatchMatch);
        
        const isSameAsOriginal = (targetPrefix === (state.orig[day]?.charAt(0).toUpperCase() || "D"));
        const isCollapsed = isSameAsOriginal ? true : state.collapsedDays[day];

        let html = '';
        if (isSameAsOriginal && !state.selectedDays.includes(day)) {
            return `<button class="collapse-btn" style="background:#f9f9f9" onclick="state.collapsedDays[${day}]=false; render();">
                        <span>é¡¯ç¤ºåŒç­åå–® (${candidates.length}äºº)</span>
                    </button>`;
        }

        heroes.forEach(c => {
            html += `<div class="person-card ${c.res.restErr ? 'cannot-swap' : 'can-swap'} batch-hero">
                <div style="display:flex; justify-content:space-between;">
                    <span>ğŸ¯ ${c.name}</span>
                    <span style="font-size:10px; color:#666;">${c.actual}</span>
                </div>
            </div>`;
        });

        if (others.length > 0) {
            if (isCollapsed) {
                html += `<button class="collapse-btn" onclick="toggleCollapse(${day})">
                    <span>${heroes.length > 0 ? 'å…¶ä»–å‚™é¸' : 'å±•é–‹åå–®'}</span>
                    <span>(${others.length}äºº)</span>
                </button>`;
            } else {
                html += `<button class="collapse-btn" onclick="toggleCollapse(${day})">â–¼ æ”¶åˆ</button>`;
                others.forEach(c => {
                    html += `<div class="person-card ${c.res.restErr ? 'cannot-swap' : 'can-swap'}">
                        <div style="display:flex; justify-content:space-between;">
                            <span>${c.name}</span>
                            <span style="font-size:10px; color:#666;">${c.actual}</span>
                        </div>
                    </div>`;
                });
            }
        }
        return html;
    }
</script>
</body>
</html>
