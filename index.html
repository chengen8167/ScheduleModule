<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Áè≠Ë°®Â∞èÂπ´Êâã - v3.7.7 Stable</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        :root { --primary: #007AFF; --danger: #ff4d4f; --safe: #2e7d32; --bg: #f0f2f5; --selected: #fff9c4; --gold: #d4a017; --white: #ffffff; }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); font-size: 14px; padding-bottom: 200px; }
        .config-box { background: var(--white); padding: 12px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .row-group { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; flex-wrap: nowrap; }
        .switch-container { flex-shrink: 0; display: flex; align-items: center; gap: 4px; background: #eee; padding: 4px; border-radius: 20px; cursor: pointer; position: relative; width: 80px; height: 32px; }
        .switch-slider { position: absolute; width: 36px; height: 26px; background: var(--white); border-radius: 18px; top: 3px; left: 3px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .mode-mobile .switch-slider { left: 41px; }
        #calendarArea { display: grid; gap: 8px; padding: 8px; }
        .mode-pc #calendarArea { grid-template-columns: repeat(7, 1fr); }
        .mode-mobile #calendarArea { grid-template-columns: 1fr; }
        .day-card { background: var(--white); border-radius: 10px; padding: 10px; border: 2px solid transparent; min-height: 80px; transition: 0.2s; cursor: pointer; }
        .day-card.selected { border-color: var(--gold); background: var(--selected); }
        .date-label { display: flex; justify-content: space-between; font-weight: 800; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .person-item { padding: 6px 8px; border-radius: 4px; margin-top: 4px; font-size: 12px; border-left: 3px solid #ccc; background: #f9f9f9; }
        .perfect-match { border-left-color: var(--gold); background: #fffdf0; font-weight: bold; border-left-width: 5px; }
        .error-tag { font-size: 9px; background: #fff1f0; color: #cf1322; padding: 1px 4px; border-radius: 3px; border: 1px solid #ffa39e; margin-top: 2px; display: inline-block; }
        .batch-panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; background: white; padding: 15px; border-radius: 16px; border: 2px solid var(--gold); z-index: 2000; display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    </style>
</head>
<body class="mode-pc">

<div class="config-box">
    <div class="row-group">
        <strong style="color:var(--primary);">Áè≠Ë°® v3.7.7</strong>
        <div class="switch-container" onclick="toggleMode()">
            <div class="switch-slider"></div>
            <div class="switch-label" style="z-index:2; flex:1; text-align:center;">üíª</div>
            <div class="switch-label" style="z-index:2; flex:1; text-align:center;">üì±</div>
        </div>
    </div>
    <div class="row-group">
        <input type="file" id="xlsxIn" accept=".xlsx">
        <input type="text" id="targetId" value="A022994" style="width:80px; text-align:center;">
        <button onclick="initData()" style="background:var(--safe); color:white; border:none; padding:8px 12px; border-radius:8px; font-weight:bold;">ÂàÜÊûê</button>
    </div>
</div>

<div id="calendarArea"></div>

<div id="batchPanel" class="batch-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><b id="selText">Â∑≤ÈÅ∏ 0 Â§©</b><button onclick="closePanel()" style="border:none; background:none; color:#999;">ÈóúÈñâ</button></div>
    <select id="shiftSel" onchange="renderUI()" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px;"></select>
    <button onclick="alert('Ê™¢Ê†∏ÂÆåÁï¢')" style="width:100%; background:var(--danger); color:white; border:none; padding:12px; border-radius:8px; font-weight:bold;">Âü∑Ë°åÊ®°Êì¨</button>
</div>

<script>
    const TIME_TABLE = { "E": ["05:15","14:45"], "F": ["06:30","16:30"], "G": ["07:00","16:00"], "J": ["10:00","20:00"], "N": ["14:30","00:30"], "O": ["15:30","01:30"], "D": ["09:00","18:00"] };
    const EXCLUDE_COLORS = ["FFFF99", "FF99CC", "99CCFF", "CCFFFF"];
    let state = { master: {}, personal: {}, dayKeys: [], selectedDays: [], mode: 'pc', expanded: {} };

    function toM(t) { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; }
    function getShift(txt) { 
        if (!txt) return null;
        const s = String(txt).trim();
        return s ? s.charAt(0).toUpperCase() : null;
    }
    function isConflicting(preS, curS) {
        const p = TIME_TABLE[getShift(preS)], c = TIME_TABLE[getShift(curS)];
        if(!p || !c) return false;
        return ((toM(c[0]) + 1440) - toM(p[1])) < 660;
    }
    function toggleMode() { state.mode = (state.mode === 'pc' ? 'mobile' : 'pc'); document.body.className = `mode-${state.mode}`; renderUI(); }

    async function initData() {
        const f = document.getElementById('xlsxIn').files[0];
        if(!f) return;
        try {
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(await f.arrayBuffer());
            const worksheet = workbook.getWorksheet(1);
            state.personal = {}; state.dayKeys = []; state.selectedDays = [];
            let hIdx = -1;
            
            worksheet.eachRow((r, n) => {
                if(hIdx !== -1) return;
                r.eachCell(c => {
                    if(c && c.value && String(c.value).includes("Âì°Â∑•Á∑®Ëôü")) hIdx = n;
                });
            });

            if(hIdx === -1) { alert("Êâæ‰∏çÂà∞Ê®ôÈ°åÂàó"); return; }

            worksheet.getRow(hIdx).eachCell((c, n) => {
                const v = c && c.value ? String(c.value).trim() : "";
                if(v.includes("/")) state.dayKeys.push({label: v, col: n});
            });

            worksheet.eachRow((r, n) => {
                if(n <= hIdx) return;
                const idVal = r.getCell(2).value;
                const nameVal = r.getCell(3).value;
                const id = idVal ? String(idVal).toUpperCase().trim() : "";
                const name = nameVal ? String(nameVal).trim() : "";
                
                if(!id || id === "NULL" || id.includes("Á∏ΩË®à")) return;

                state.personal[name] = { id, schedule: {} };
                state.dayKeys.forEach(dk => {
                    const cell = r.getCell(dk.col);
                    const val = cell ? (cell.text || String(cell.value || "")).trim() : "D1";
                    let hex = "000000";
                    try { 
                        if(cell && cell.fill && cell.fill.fgColor && cell.fill.fgColor.argb) 
                            hex = String(cell.fill.fgColor.argb).slice(-6).toUpperCase(); 
                    } catch(e){}
                    state.personal[name].schedule[dk.label] = { text: val || "D1", hex, isForb: EXCLUDE_COLORS.includes(hex) };
                });
            });
            renderUI();
        } catch (e) { alert("ÈåØË™§Ôºö" + e.message); }
    }

    function renderUI() {
        const area = document.getElementById('calendarArea');
        const myId = document.getElementById('targetId').value.toUpperCase();
        const myName = Object.keys(state.personal).find(n => state.personal[n].id === myId);
        if(!myName) { area.innerHTML = "Â∞öÊú™ËºâÂÖ•ÊàñÁ∑®ËôüÈåØË™§"; return; }

        const labels = state.dayKeys.map(k => k.label);
        let stats = {};

        if(state.selectedDays.length > 0) {
            Object.keys(state.personal).forEach(n => {
                if(n === myName) return;
                stats[n] = { errors: [], canEx: true };
                let mock = {};
                labels.forEach(d => {
                    mock[d] = state.selectedDays.includes(d) ? state.personal[myName].schedule[d].text : state.personal[n].schedule[d].text;
                });

                labels.forEach((d, i) => {
                    if(i === 0) return;
                    if(isConflicting(mock[labels[i-1]], mock[d])) {
                        stats[n].errors.push(`${d.split('/')[1]}Êó•‰∏çË∂≥`);
                        if(state.selectedDays.includes(d) || state.selectedDays.includes(labels[i-1])) stats[n].canEx = false;
                    }
                });
                
                state.selectedDays.forEach(d => {
                    const myS = state.personal[myName].schedule[d], cS = state.personal[n].schedule[d];
                    const target = document.getElementById('shiftSel')?.value || getShift(myS.text);
                    if(getShift(cS.text) !== target) { stats[n].errors.push("Áè≠Âà•‰∏çÁ¨¶"); stats[n].canEx = false; }
                    if(cS.isForb) { stats[n].errors.push("Ë∫´ÂàÜÈôêÂà∂"); stats[n].canEx = false; }
                });
            });
        }

        area.innerHTML = labels.map(d => {
            const isSel = state.selectedDays.includes(d);
            const myS = state.personal[myName].schedule[d];
            const targetT = document.getElementById('shiftSel')?.value || getShift(myS.text);
            
            let top = "", others = "", otherCount = 0;
            Object.keys(state.personal).forEach(n => {
                if(n === myName) return;
                const cS = state.personal[n].schedule[d];
                const s = stats[n] || { canEx: false, errors: [] };
                
                if(isSel && s.canEx) {
                    top += `<div class="person-item perfect-match"><div style="color:#${cS.hex}">${n} (${cS.text}) ‚ú®</div></div>`;
                } else if(getShift(cS.text) === targetT) {
                    otherCount++;
                    if(state.expanded[d]) {
                        let eTags = isSel ? [...new Set(s.errors)].map(e => `<span class="error-tag">${e}</span>`).join('') : '';
                        others += `<div class="person-item"><div style="color:#${cS.hex}">${n} (${cS.text})</div>${eTags}</div>`;
                    }
                }
            });

            return `<div class="day-card ${isSel?'selected':''}" onclick="toggleSelect('${d}')">
                <div class="date-label">${d.split('/')[1]}Êó• <span>${myS.text}</span></div>
                ${top}
                <div onclick="event.stopPropagation(); state.expanded['${d}']=!state.expanded['${d}']; renderUI();" style="font-size:10px; color:#999; margin-top:5px; text-align:center;">
                    ${otherCount > 0 ? (state.expanded[d] ? 'Êî∂Ëµ∑' : 'ÂÖ∂‰ªñ '+otherCount) : ''}
                </div>
                ${others}
            </div>`;
        }).join('');
    }

    function toggleSelect(d) {
        if(state.selectedDays.includes(d)) state.selectedDays = state.selectedDays.filter(x => x !== d);
        else state.selectedDays.push(d);
        
        const bp = document.getElementById('batchPanel');
        if(state.selectedDays.length > 0) {
            bp.style.display = 'block';
            document.getElementById('selText').innerText = `Â∑≤ÈÅ∏ ${state.selectedDays.length} Â§©`;
            let opt = '<option value="">Áè≠Âà•(È†êË®≠)</option>';
            ['E','F','G','J','N','O'].forEach(s => opt += `<option value="${s}">${s} Áè≠</option>`);
            document.getElementById('shiftSel').innerHTML = opt;
        } else bp.style.display = 'none';
        renderUI();
    }
    function closePanel() { state.selectedDays = []; document.getElementById('batchPanel').style.display = 'none'; renderUI(); }
</script>
</body>
</html>
