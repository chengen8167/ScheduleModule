<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Áè≠Ë°®Â∞èÂπ´Êâã - v3.7.3 Stable</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        :root { --primary: #007AFF; --danger: #ff4d4f; --safe: #2e7d32; --bg: #f0f2f5; --selected: #fff9c4; --gold: #d4a017; --white: #ffffff; }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); font-size: 14px; padding-bottom: 200px; }
        .config-box { background: var(--white); padding: 12px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .row-group { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; flex-wrap: nowrap; overflow: visible; }
        .switch-container { flex-shrink: 0; display: flex; align-items: center; gap: 4px; background: #eee; padding: 4px; border-radius: 20px; cursor: pointer; position: relative; width: 80px; height: 32px; user-select: none; }
        .switch-label { flex: 1; text-align: center; z-index: 2; font-size: 14px; }
        .switch-slider { position: absolute; width: 36px; height: 26px; background: var(--white); border-radius: 18px; top: 3px; left: 3px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .mode-mobile .switch-slider { left: 41px; }
        .summary-box { background: #fff; margin: 8px; padding: 12px; border-radius: 10px; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #calendarArea { display: grid; gap: 8px; padding: 8px; }
        .mode-pc { grid-template-columns: repeat(7, 1fr); }
        .mode-mobile { grid-template-columns: 1fr; }
        .day-card { background: var(--white); border-radius: 10px; padding: 10px; border: 2px solid transparent; min-height: 80px; transition: 0.2s; cursor: pointer; }
        .day-card.selected { border-color: var(--gold); background: var(--selected); }
        .date-label { display: flex; justify-content: space-between; font-weight: 800; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .shift-note { font-size: 9px; color: #ff7875; font-weight: normal; margin-left: 4px; font-style: italic; }
        .person-item { padding: 6px 8px; border-radius: 4px; margin-top: 4px; font-size: 12px; border-left: 3px solid #ccc; background: #f9f9f9; display: flex; flex-direction: column; }
        .colored-name { font-weight: 900; color: #000000; } 
        .perfect-match { border-left-color: var(--gold); background: #fffdf0; font-weight: bold; border-left-width: 5px; cursor: pointer; }
        .perfect-match.target-selected { background: #fff3cd; border: 2px solid var(--gold); }
        .btn-collapse { width: 100%; border: none; background: #eee; color: #666; font-size: 10px; padding: 8px; border-radius: 4px; cursor: pointer; margin-top: 8px; }
        .error-tag { font-size: 9px; background: #fff1f0; color: #cf1322; padding: 1px 4px; border-radius: 3px; border: 1px solid #ffa39e; margin-right: 2px; display: inline-block; margin-top: 2px; font-weight: bold; }
        .batch-panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; background: rgba(255, 251, 230, 0.96); backdrop-filter: blur(12px); padding: 15px; border-radius: 16px; border: 2px solid #ffe58f; box-shadow: 0 -4px 25px rgba(0,0,0,0.18); z-index: 2000; display: none; }
        .btn-execute { background: var(--danger); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 900; font-size: 16px; cursor: pointer; width: 100%; margin-top: 10px; }
    </style>
</head>
<body class="mode-pc">

<div class="config-box">
    <div class="row-group">
        <strong style="color:var(--primary); white-space: nowrap;">Áè≠Ë°®Â∞èÂπ´Êâã v3.7.3</strong>
        <div class="switch-container" onclick="toggleMode()">
            <div class="switch-slider"></div>
            <div class="switch-label">üíª</div>
            <div class="switch-label">üì±</div>
        </div>
        <span style="font-size:10px; color:#999; margin-left:auto;">Stable Build</span>
    </div>
    <div class="row-group">
        <input type="file" id="xlsxIn" accept=".xlsx" style="flex:1; min-width:120px;">
        <input type="text" id="targetId" value="A022994" style="width:80px; text-align:center;">
        <button onclick="initData()" id="btnAnalyze" style="background:var(--safe); color:white; border:none; padding:8px 15px; border-radius:8px; font-weight:bold; flex-shrink:0;">ÂàÜÊûê</button>
    </div>
</div>

<div id="summaryArea" class="summary-box" style="display:none;">
    <div id="summaryTitle" style="font-weight:bold; margin-bottom:8px; display:flex; justify-content:space-between;"></div>
    <div id="summaryList"></div>
</div>

<div id="batchPanel" class="batch-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
        <span style="font-weight:bold;">üìÖ Â∑≤ÈÅ∏Ôºö<span id="selText">0</span> Â§©</span>
        <button onclick="closePanel()" style="background:none; border:none; color:#999; font-size:24px;">&times;</button>
    </div>
    <div id="selectedTargetDisplay" style="font-weight:bold; color:var(--danger); margin-bottom: 8px; font-size:13px;">Â∞çË±°ÔºöÂ∞öÊú™ÈÅ∏Êìá</div>
    <select id="shiftSel" onchange="renderUI()" style="width:100%; padding:10px; border-radius:8px; border:2px solid var(--primary);"></select>
    <button class="btn-execute" onclick="executeBatch()">Âü∑Ë°åÊèõÁè≠</button>
</div>

<div id="calendarArea" class="mode-pc"></div>

<script>
    const TIME_TABLE = { "E159G": ["05:15","14:45"], "F30XA": ["06:30","16:30"], "G009A": ["07:00","16:00"], "J00XA": ["10:00","20:00"], "N008A": ["14:00","22:00"], "N30XA": ["14:30","00:30"], "O30XA": ["15:30","01:30"], "D1": ["09:00","18:00"] };
    const EXCLUDE_COLORS = ["FFFF99", "FF99CC", "99CCFF", "CCFFFF"];
    let state = { master: {}, personal: {}, dayKeys: [], selectedDays: [], mode: 'pc', expanded: {}, chosenTarget: null, changeLogs: [] };

    window.onload = function() { setMode(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'mobile' : 'pc'); };

    function toM(t) { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; }
    function isConflicting(preEndShift, curStartShift) {
        const p = TIME_TABLE[preEndShift?.split('/')[0]], c = TIME_TABLE[curStartShift?.split('/')[0]];
        if(!p || !c) return false;
        return ((toM(c[0]) + 1440) - toM(p[1])) < 660;
    }

    function renderUI() {
        const area = document.getElementById('calendarArea'), dayLabels = state.dayKeys.map(k => k.label);
        const myName = Object.keys(state.personal).find(n => state.personal[n].id === document.getElementById('targetId').value.toUpperCase());
        if(!myName || dayLabels.length === 0) return;
        let targetPrefix = document.getElementById('shiftSel')?.value || "";

        let userStats = {};
        if(state.selectedDays.length > 0) {
            Object.keys(state.personal).forEach(n => {
                if(n === myName) return;
                userStats[n] = { errors: [], canExchange: true };
                
                // Âª∫Á´ãÊ®°Êì¨Áè≠Ë°®
                let mockFullSchedule = {};
                dayLabels.forEach(d => {
                    mockFullSchedule[d] = state.selectedDays.includes(d) ? state.personal[myName].schedule[d].text : state.personal[n].schedule[d].text;
                });

                // Ê™¢Êü•ÂÖ®Èáè‰ºëÊÅØË¶èÂâá (Âê´ÂâçÂæåÂΩ±Èüø)
                dayLabels.forEach((d, idx) => {
                    if (idx === 0) return;
                    if (isConflicting(mockFullSchedule[dayLabels[idx-1]], mockFullSchedule[d])) {
                        // Ê®ôË®òÈåØË™§
                        userStats[n].errors.push(`${d.split('/')[1]}Êó•‰ºëÊÅØ‰∏çË∂≥`);
                        // üöÄ ÈóúÈçµ‰øÆÊ≠£ÔºöÂè™Ë¶ÅÈÄô‰ªΩÊ®°Êì¨Áè≠Ë°®Êúâ‰ªª‰Ωï‰∏ÄÂ§©Ë°ùÁ™ÅÔºå‰∏îÈÄôË°ùÁ™ÅËàáÊèõÁè≠Êó•ÊúâÈóúÔºåÂ∞±Á¶ÅÊ≠¢ÈÖçÂ∞ç
                        if (state.selectedDays.includes(d) || state.selectedDays.includes(dayLabels[idx-1])) {
                            userStats[n].canExchange = false;
                        }
                    }
                });

                // Ê™¢Êü•ÈÄ£ÂÖ≠
                let cnt = 0;
                dayLabels.forEach(d => {
                    if (mockFullSchedule[d] !== "D1") cnt++; else cnt = 0;
                    if (cnt > 6) { userStats[n].errors.push("ÈÄ£ÂÖ≠Ë¶èÂâáÈÅïÂèç"); userStats[n].canExchange = false; }
                });

                // Ê™¢Êü•Áï∂Â§©Áè≠Âà•ËàáË∫´ÂàÜ
                state.selectedDays.forEach(d => {
                    const myS = state.personal[myName].schedule[d], cS = state.personal[n].schedule[d];
                    const target = targetPrefix || myS.text.charAt(0).toUpperCase();
                    if (cS.text.charAt(0).toUpperCase() !== target) {
                        userStats[n].errors.push(`${d.split('/')[1]}Êó•Áè≠Âà•‰∏çÁ¨¶`);
                        userStats[n].canExchange = false;
                    }
                    if (cS.isForb) {
                        userStats[n].errors.push(`${d.split('/')[1]}Êó•Ë∫´ÂàÜÈôêÂà∂`);
                        userStats[n].canExchange = false;
                    }
                });
            });
        }

        area.innerHTML = dayLabels.map(d => {
            const isSelectedDay = state.selectedDays.includes(d), isExp = !!state.expanded[d], myS = state.personal[myName].schedule[d];
            const currT = targetPrefix || myS.text.charAt(0).toUpperCase();
            let topHTML = "", otherHTML = "", otherCount = 0;

            Object.keys(state.personal).forEach(n => {
                if(n === myName) return;
                const stats = userStats[n] || { canExchange: false, errors: [] };
                const cS = state.personal[n].schedule[d];
                const isMatchPrefix = cS.text.charAt(0).toUpperCase() === currT;

                if (isSelectedDay && stats.canExchange) {
                    topHTML += `<div class="person-item perfect-match" onclick="event.stopPropagation(); selectTargetPerson('${n}')">
                        <div style="display:flex;justify-content:space-between;align-items:center;"><span class="colored-name" style="color:#${cS.hex} !important;">${n} <small style="color:#666">(${cS.text})</small></span><b>‚ú®</b></div>
                    </div>`;
                } else if (isMatchPrefix) {
                    otherCount++;
                    if(isExp) {
                        let errTags = isSelectedDay ? [...new Set(stats.errors)].map(e => `<span class="error-tag">${e}</span>`).join('') : '';
                        otherHTML += `<div class="person-item"><div style="display:flex;justify-content:space-between;align-items:center;"><span class="colored-name" style="color:#${cS.hex} !important;">${n} <small style="color:#666">(${cS.text})</small></span></div><div>${errTags}</div></div>`;
                    }
                }
            });

            return `<div class="day-card ${isSelectedDay?'selected':''}" onclick="toggleSelect('${d}')">
                <div class="date-label">${d.split('/')[1]}Êó• <span>${myS.text}${myS.note}</span></div>
                <div style="margin-top:5px;">${topHTML}<button class="btn-collapse" onclick="toggleExpand(event, '${d}')">${isExp ? 'Êî∂Ëµ∑' : `ÂÖ∂‰ªñ(${otherCount})`}</button><div style="margin-top:4px;">${otherHTML}</div></div>
            </div>`;
        }).join('');
    }

    // --- Ââ©È§òËºîÂä©ÂáΩÊï∏ (Á∂≠ÊåÅÂéüÁãÄ) ---
    function setMode(m) { state.mode = m; document.body.className = `mode-${m}`; document.getElementById('calendarArea').className = `mode-${m}`; renderUI(); }
    function toggleMode() { setMode(state.mode === 'pc' ? 'mobile' : 'pc'); }
    function closePanel() { state.selectedDays = []; state.chosenTarget = null; document.getElementById('batchPanel').style.display = 'none'; renderUI(); }
    async function initData() {
        const f = document.getElementById('xlsxIn').files[0]; if(!f) return;
        const workbook = new ExcelJS.Workbook(); await workbook.xlsx.load(await f.arrayBuffer()); const worksheet = workbook.getWorksheet(1);
        state.personal = {}; state.master = {}; state.dayKeys = [];
        let hIdx = -1; worksheet.eachRow((r, n) => { r.eachCell(c => { if(String(c.value).includes("Âì°Â∑•Á∑®Ëôü")) hIdx = n; }); });
        worksheet.getRow(hIdx).eachCell((c, n) => { if(String(c.value).includes("/")) state.dayKeys.push({label: String(c.value).trim(), col: n}); });
        worksheet.eachRow((r, n) => {
            if(n <= hIdx) return; const name = String(r.getCell(3).value), id = String(r.getCell(2).value).toUpperCase();
            if(!id || id.includes("Á∏ΩË®à")) return; state.personal[name] = { id, schedule: {} };
            state.dayKeys.forEach(dk => {
                const c = r.getCell(dk.col); let v = (c.text || String(c.value || "")).trim() || "D1";
                let hex = "000000"; try { hex = c.fill.fgColor.argb.slice(-6); } catch(e){}
                state.personal[name].schedule[dk.label] = { text: v, hex, isForb: EXCLUDE_COLORS.includes(hex), note: "" };
                const p = v[0].toUpperCase(); if(/^[A-Z]$/.test(p)){
                    if(!state.master[dk.label]) state.master[dk.label] = {};
                    if(!state.master[dk.label][p]) state.master[dk.label][p] = [];
                    state.master[dk.label][p].push({name, text: v});
                }
            });
        }); renderUI();
    }
    function toggleSelect(d) {
        const labels = state.dayKeys.map(k => k.label), idx = labels.indexOf(d);
        if (state.selectedDays.includes(d)) state.selectedDays.splice(state.selectedDays.indexOf(d), 1);
        else {
            if (state.selectedDays.length > 0) {
                const indices = state.selectedDays.map(day => labels.indexOf(day)).sort((a,b)=>a-b);
                if (idx === indices[0] - 1 || idx === indices[indices.length - 1] + 1) state.selectedDays.push(d);
                else state.selectedDays = [d];
            } else state.selectedDays.push(d);
        }
        if(state.selectedDays.length > 0) {
            document.getElementById('batchPanel').style.display = 'block';
            document.getElementById('selText').innerText = state.selectedDays.length;
            let sets = new Set(); state.selectedDays.forEach(day => Object.keys(state.master[day]||{}).forEach(p => { if(/^[A-Z]$/.test(p)) sets.add(p); }));
            let opt = '<option value="">(ÂàùÂßã) È°ØÁ§∫ÂêåÁè≠Âà•ÂêçÂñÆ</option>';
            Array.from(sets).sort().forEach(p => opt += `<option value="${p}">${p} Áè≠</option>`);
            document.getElementById('shiftSel').innerHTML = opt;
        } else document.getElementById('batchPanel').style.display = 'none';
        renderUI();
    }
    function toggleExpand(e, d) { e.stopPropagation(); state.expanded[d] = !state.expanded[d]; renderUI(); }
    function selectTargetPerson(name) { state.chosenTarget = name; document.getElementById('selectedTargetDisplay').innerText = `Â∞çË±°Ôºö${name}`; }
    function executeBatch() {
        const me = Object.keys(state.personal).find(n => state.personal[n].id === document.getElementById('targetId').value.toUpperCase());
        if(!state.chosenTarget) return;
        state.selectedDays.forEach(d => {
            const myS = state.personal[me].schedule[d], hS = state.personal[state.chosenTarget].schedule[d];
            state.changeLogs.push({ date: d, person: state.chosenTarget, from: myS.text, to: hS.text });
            let oM = myS.text, oH = hS.text; myS.text = oH; hS.text = oM;
            myS.note = ` ‚áÑ ${state.chosenTarget}`; hS.note = ` ‚áÑ ${me}`;
        });
        document.getElementById('summaryArea').style.display = 'block';
        document.getElementById('summaryList').innerHTML = state.changeLogs.map(l => `‚Ä¢ ${l.date.split('/')[1]}Êó•: ${l.person} ${l.to} ‚áÑ Êàë ${l.from}`).join('<br>');
        closePanel();
    }
</script>
</body>
</html>
