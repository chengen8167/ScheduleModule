<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­è¡¨æ¨¡æ“¬å™¨ - æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007AFF; --danger: #ff4d4f; --safe: #2e7d32; --bg: #f0f2f5; }
        
        * { box-sizing: border-box; } /* é˜²æ­¢å¯¬åº¦è¢«å…§é‚Šè·æ’ç ´çš„é—œéµ */

        body { 
            font-family: -apple-system, sans-serif; 
            margin: 0; 
            background: var(--bg); 
            font-size: 14px;
            width: 100%;
            overflow-x: hidden; /* ç¦æ­¢å·¦å³æ™ƒå‹• */
        }

        /* é ‚éƒ¨é…ç½®å€å„ªåŒ– */
        .config-box { 
            background: #fff; 
            padding: 10px; 
            border-bottom: 1px solid #ddd; 
            position: sticky; 
            top: 0; 
            z-index: 100;
        }
        
        .input-group { 
            display: flex; 
            flex-direction: column; /* æ‰‹æ©Ÿå„ªå…ˆï¼šå‚ç›´æ’åˆ— */
            gap: 8px; 
            max-width: 100%;
        }

        .row-group {
            display: flex;
            gap: 8px;
            align-items: center;
            width: 100%;
        }

        .file-input-wrapper { 
            background: #f8f9fa; 
            padding: 8px; 
            border-radius: 6px; 
            border: 1px dashed #ccc; 
            font-size: 12px;
            flex: 1;
        }

        input[type="text"] { 
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            width: 80px; 
            font-weight: bold;
        }

        .controls { 
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* ä¸‰æŒ‰éˆ•å¹³å‡åˆ†é… */
            gap: 5px;
            width: 100%;
        }

        button { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 8px 5px; 
            border-radius: 6px; 
            font-weight: bold; 
            font-size: 12px;
            white-space: nowrap;
        }
        
        button.secondary { background: #6c757d; }

        /* æœˆæ›†å®¹å™¨ */
        #calendar-container { 
            width: 100%;
            padding: 10px;
        }
        
        /* è¡¨æ ¼èˆ‡åˆ—è¡¨åˆ‡æ›é‚è¼¯ */
        table { width: 100%; border-collapse: collapse; }

        /* é è¨­æ‰‹æ©Ÿç‰ˆï¼šè½‰ç‚ºå¡ç‰‡ */
        @media (max-width: 768px) {
            #calendarArea:not(.force-table) table, 
            #calendarArea:not(.force-table) tr, 
            #calendarArea:not(.force-table) td { 
                display: block; 
                width: 100%; 
            }
            #calendarArea:not(.force-table) thead { display: none; }
            #calendarArea:not(.force-table) td { 
                background: white;
                margin-bottom: 15px; 
                border-radius: 12px; 
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                border: 1px solid #eee;
                padding: 15px;
                height: auto !important;
            }
        }

        /* é›»è…¦ç‰ˆæ¨¡å¼å¼·åˆ¶ä¿®æ­£ */
        .force-table { overflow-x: auto; display: block; }
        .force-table table { min-width: 800px; background: white; }
        .force-table td { height: 160px; border: 1px solid #eee; vertical-align: top; padding: 5px; }

        /* ä¸‹æ‹‰é¸å–® */
        .shift-select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid var(--primary); 
            background: #fff; 
            color: var(--primary); 
            border-radius: 8px; 
            font-weight: bold; 
            font-size: 16px; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
            margin: 10px 0;
        }

        .date-header { display: flex; justify-content: space-between; align-items: center; }
        .date-num { font-size: 1.4em; font-weight: 800; color: #333; }
        .orig-tag { font-size: 11px; color: #999; }
        
        /* åå–®å¡ç‰‡ */
        .names-list { margin-top: 10px; border-top: 1px solid #f0f0f0; padding-top: 5px; }
        .person-card { 
            padding: 8px; 
            border-radius: 8px; 
            margin-bottom: 6px; 
            border-left: 5px solid #ccc;
        }
        .card-row { display: flex; justify-content: space-between; align-items: center; }
        .name-txt { font-weight: bold; font-size: 13px; }
        .actual-shift-txt { font-size: 10px; color: #666; background: #eee; padding: 2px 5px; border-radius: 4px; }
        
        .can-swap { border-left-color: var(--safe); background: #f6ffed; }
        .cannot-swap { border-left-color: var(--danger); background: #fff1f0; }
        .warning-tag { color: var(--danger); font-size: 10px; font-weight: bold; margin-top: 3px; display: block; }
    </style>
</head>
<body>

<div class="config-box">
    <div class="input-group">
        <div class="row-group">
            <div class="file-input-wrapper">
                <input type="file" id="uploadAll" accept=".xlsx, .xls, .html" style="width: 100%;">
            </div>
            <input type="text" id="empId" value="A022994">
            <button onclick="run()" style="padding: 8px 15px;">åˆ†æ</button>
        </div>
        <div class="controls">
            <button class="secondary" onclick="setMode('auto')">ğŸŒ“ è‡ªå‹•</button>
            <button class="secondary" onclick="setMode('table')">ğŸ’» é›»è…¦</button>
            <button class="secondary" onclick="setMode('list')">ğŸ“± æ‰‹æ©Ÿ</button>
        </div>
    </div>
</div>

<div id="calendar-container">
    <div id="displayUser" style="margin: 5px 0 10px 5px; font-weight: bold; color: var(--primary);"></div>
    <div id="calendarArea"></div>
</div>

<script>
    const SHIFT_DB = { 
        "E159G": ["05:15","14:45"], "E159J": ["05:15","15:00"], "E15XA": ["05:15","15:15"], 
        "F00XA": ["06:00","16:00"], "F308A": ["06:30","14:30"], "F309G": ["06:30","16:00"], "F30XA": ["06:30","16:30"], 
        "G008A": ["07:00","15:00"], "G009A": ["07:00","16:00"], "G158A": ["07:15","15:15"], "G308A": ["07:30","15:30"], 
        "J00XA": ["10:00","20:00"], "J308A": ["10:30","18:30"], "K008A": ["11:00","19:00"], "L008A": ["12:00","20:00"], 
        "N008A": ["14:00","22:00"], "N009A": ["14:00","23:00"], "N009G": ["14:00","23:30"], "N308A": ["14:30","22:30"], 
        "N309A": ["14:30","23:30"], "N30XA": ["14:30","00:30"], "O008A": ["15:00","23:00"], "O308A": ["15:30","23:30"], 
        "O309A": ["15:30","00:30"], "O309G": ["15:30","00:45"], "O30XA": ["15:30","01:30"], "TRN": ["08:30","17:30"] 
    };
    const OFF_LIST = ['AL', 'D1', 'D2', 'D2A', 'D3', 'D3X', 'LEV', 'ä¼‘', ''];
    let state = { master: {}, personal: {}, orig: {}, simPrefix: {}, year: 2026, month: 0, userName: "", targetId: "A022994" };

    function getTime(s) { if (!s) return null; const key = s.toUpperCase().split('/')[0]; return SHIFT_DB[key] || null; }
    function isOff(s) { return !s || OFF_LIST.includes(s.toUpperCase()) || !getTime(s); }
    function getRest(pre, nxt) { 
        const p = getTime(pre), n = getTime(nxt); if (!p || !n) return 24; 
        const [pH, pM] = p[1].split(':').map(Number); const [nH, nM] = n[0].split(':').map(Number); 
        return ((nH + 24) * 60 + nM - (pH * 60 + pM)) / 60; 
    }

    function checkLegality(schedule, d) {
        const rPre = getRest(schedule[d-1], schedule[d]); const rNxt = getRest(schedule[d], schedule[d+1]);
        let streak = 0;
        for (let i = d; i >= 1; i--) { if (!isOff(schedule[i])) streak++; else break; }
        for (let i = d + 1; i <= 31; i++) { if (!isOff(schedule[i])) streak++; else break; }
        return { restErr: rPre < 11 || rNxt < 11, streakErr: streak > 6, rVal: Math.min(rPre, rNxt), sVal: streak };
    }

    function setMode(mode) {
        const area = document.getElementById('calendarArea');
        area.className = (mode === 'table' ? 'force-table' : (mode === 'list' ? 'mode-list' : ''));
    }

    document.getElementById('uploadAll').onchange = function(e) {
        const file = e.target.files[0]; if (!file) return;
        state.targetId = document.getElementById('empId').value.trim().toUpperCase();
        const reader = new FileReader();
        if (file.name.endsWith('.html')) {
            reader.onload = (ev) => {
                const rows = Array.from(new DOMParser().parseFromString(ev.target.result, 'text/html').querySelectorAll('tr'));
                processRows(rows, (r) => r.querySelectorAll('td')[2]?.innerText, (r, d) => r.querySelectorAll('td')[d+3]?.innerText, (r) => r.querySelectorAll('td')[3]?.innerText.trim().toUpperCase());
                run();
            };
            reader.readAsText(file);
        } else {
            reader.onload = (ev) => {
                const sheet = XLSX.read(new Uint8Array(ev.target.result), {type:'array'}).Sheets;
                const rows = XLSX.utils.sheet_to_json(sheet[Object.keys(sheet)[0]], {header:1, defval:""});
                const ym = String(rows[4][0]).match(/\d+/g); state.year = ym[0]; state.month = ym[1]-1;
                let dCols = {}; rows[5].forEach((c, i) => { if(!isNaN(parseInt(c))) dCols[parseInt(c)] = i; });
                processRows(rows, (r) => r[2], (r, d) => r[dCols[d]], (r) => String(r[3]).trim().toUpperCase());
                run();
            };
            reader.readAsArrayBuffer(file);
        }
    };

    function processRows(rows, getName, getShift, getId) {
        state.master = {}; state.personal = {};
        rows.forEach(r => {
            const id = getId(r), name = getName(r); if (!id || !name) return;
            state.personal[name] = { id: id };
            for(let d=1; d<=31; d++) {
                let s = (getShift(r, d) || "").trim();
                state.personal[name][d] = s;
                if(s && isNaN(s)) {
                    const prefix = s.charAt(0).toUpperCase();
                    if(!state.master[d]) state.master[d] = {};
                    if(!state.master[d][prefix]) state.master[d][prefix] = [];
                    state.master[d][prefix].push({ name: name, actual: s });
                }
            }
        });
    }

    function run() {
        let entry = Object.values(state.personal).find(p => p.id === state.targetId);
        if(!entry) return alert("æŸ¥ç„¡å·¥è™Ÿ");
        state.userName = Object.keys(state.personal).find(k => state.personal[k].id === state.targetId);
        document.getElementById('displayUser').innerText = `ğŸ‘¤ ${state.userName} (${state.year}/${state.month+1})`;
        for(let d=1; d<=31; d++) { 
            state.orig[d] = entry[d] || ""; 
            state.simPrefix[d] = state.orig[d] ? state.orig[d].charAt(0).toUpperCase() : ""; 
        }
        render();
    }

    function render() {
        const last = new Date(state.year, state.month + 1, 0).getDate();
        const startDay = new Date(state.year, state.month, 1).getDay();
        let html = `<table><tbody><tr>`;
        for(let i=0; i<startDay; i++) html += `<td class="empty"></td>`;
        for(let d=1; d<=last; d++) {
            if((startDay+d-1)%7===0 && d!==1) html += `</tr><tr>`;
            let schedule = {...state.orig};
            const res = checkLegality(schedule, d);
            
            html += `<td>
                <div class="date-header"><span class="date-num">${d}</span><span class="orig-tag">åŸ:${state.orig[d]||'ä¼‘'}</span></div>
                <select class="shift-select" onchange="state.simPrefix[${d}]=this.value; render();">
                    <option value="">ä¼‘</option>
                    ${renderPrefixOptions(d)}
                </select>
                ${res.restErr ? `<span class="warning-tag">âš ï¸ ä½ ä¼‘æ¯ä¸è¶³</span>` : ''}
                <div class="names-list">${getGroupedSwapList(d, state.simPrefix[d])}</div>
            </td>`;
        }
        document.getElementById('calendarArea').innerHTML = html + `</tr></tbody></table>`;
    }

    function renderPrefixOptions(day) {
        if (!state.master[day]) return "";
        return Object.keys(state.master[day]).sort().map(p => `<option value="${p}" ${p === state.simPrefix[day] ? 'selected' : ''}>${p} ç­</option>`).join('');
    }

    function getGroupedSwapList(day, prefix) {
        if(!prefix || !state.master[day] || !state.master[day][prefix]) return "";
        return state.master[day][prefix].map(item => {
            if(item.name === state.userName) return "";
            let oSched = {...state.personal[item.name]};
            oSched[day] = state.orig[day];
            const res = checkLegality(oSched, day);
            return `<div class="person-card ${!res.restErr && !res.streakErr ? 'can-swap' : 'cannot-swap'}">
                <div class="card-row">
                    <span class="name-txt">${!res.restErr && !res.streakErr ? 'âœ…' : 'âŒ'} ${item.name}</span>
                    <span class="actual-shift-txt">${item.actual}</span>
                </div>
                ${res.restErr ? `<span class="warning-tag">âš ï¸ å°æ–¹ä¼‘æ¯ä¸è¶³</span>` : ''}
                ${res.streakErr ? `<span class="warning-tag">âš ï¸ å°æ–¹é€£ä¸Šç­${res.sVal}å¤©</span>` : ''}
            </div>`;
        }).join('');
    }
</script>
</body>
</html>
