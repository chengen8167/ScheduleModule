<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­è¡¨æ¨¡æ“¬å™¨ - æ‰¹é‡æ›ç­ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007AFF; --danger: #ff4d4f; --safe: #2e7d32; --bg: #f0f2f5; --selected: #fff9c4; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); width: 100vw; overflow-x: hidden; }

        /* å›ºå®šé…ç½®å€ */
        .config-box { background: #fff; padding: 12px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        .row-group { display: flex; gap: 8px; width: 100%; }
        .file-input-wrapper { background: #f8f9fa; padding: 8px; border-radius: 8px; border: 1px dashed #ccc; flex: 1; font-size: 13px; }
        input[type="text"] { width: 80px; border: 1px solid #ccc; border-radius: 8px; text-align: center; font-weight: bold; }
        
        /* æ‰¹é‡æ“ä½œåˆ— */
        .batch-bar { 
            background: #e3f2fd; padding: 10px; border-radius: 10px; margin-top: 8px; 
            display: none; flex-direction: column; gap: 8px; border: 1px solid #90caf9;
        }
        .batch-controls { display: flex; gap: 8px; align-items: center; }

        /* æœˆæ›†ä½ˆå±€ */
        #calendar-container { width: 100%; padding: 10px; }
        @media (max-width: 768px) {
            .day-card { 
                background: white; margin-bottom: 15px; border-radius: 15px; 
                box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 2px solid transparent; padding: 16px;
            }
            .day-card.selected { border-color: #ffd600; background: var(--selected); }
        }
        
        /* å…ƒç´ æ¨£å¼ */
        .date-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .date-num { font-size: 1.6em; font-weight: 800; }
        .select-hint { font-size: 10px; color: var(--primary); font-weight: bold; }
        
        .shift-select { 
            width: 100%; padding: 12px; border: 2px solid var(--primary); 
            background: #fff; border-radius: 10px; font-weight: bold; font-size: 18px; margin: 8px 0;
        }

        .names-list { margin-top: 12px; border-top: 1px solid #eee; padding-top: 8px; }
        .person-card { padding: 10px; border-radius: 10px; margin-bottom: 8px; border-left: 6px solid #ccc; }
        .card-row { display: flex; justify-content: space-between; align-items: center; }
        .name-txt { font-weight: bold; }
        .actual-shift-txt { font-size: 10px; color: #444; background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; }
        
        .can-swap { border-left-color: var(--safe); background: #f6ffed; }
        .cannot-swap { border-left-color: var(--danger); background: #fff1f0; }
        .batch-hero { border: 2px solid var(--safe); box-shadow: 0 0 10px rgba(46,125,50,0.2); }
        .warning-tag { color: var(--danger); font-size: 11px; font-weight: bold; margin-top: 4px; display: block; }
    </style>
</head>
<body>

<div class="config-box">
    <div class="input-group">
        <div class="row-group">
            <div class="file-input-wrapper"><input type="file" id="uploadAll" accept=".xlsx, .xls, .html" style="width:100%"></div>
            <input type="text" id="empId" value="A022994">
            <button onclick="run()">åˆ†æ</button>
        </div>
        
        <div id="batchBar" class="batch-bar">
            <div style="font-size: 12px; font-weight: bold; color: #1976d2;">å·²é¸å–: <span id="selectedDaysTxt">0</span> å¤©</div>
            <div class="batch-controls">
                <select id="batchShift" class="shift-select" style="margin:0; flex:1; font-size:14px; padding:8px;">
                    <option value="">é¸æ“‡æ•´æ‰¹æ›æˆ...</option>
                </select>
                <button onclick="applyBatch()" style="background:var(--safe)">ç¢ºèªæ›´æ›</button>
                <button onclick="clearSelection()" class="secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<div id="calendar-container">
    <div id="calendarArea"></div>
</div>

<script>
    const SHIFT_DB = { "E159G": ["05:15","14:45"], "E159J": ["05:15","15:00"], "E15XA": ["05:15","15:15"], "F00XA": ["06:00","16:00"], "F308A": ["06:30","14:30"], "F309G": ["06:30","16:00"], "F30XA": ["06:30","16:30"], "G008A": ["07:00","15:00"], "G009A": ["07:00","16:00"], "G158A": ["07:15","15:15"], "G308A": ["07:30","15:30"], "J00XA": ["10:00","20:00"], "J308A": ["10:30","18:30"], "K008A": ["11:00","19:00"], "L008A": ["12:00","20:00"], "N008A": ["14:00","22:00"], "N009A": ["14:00","23:00"], "N009G": ["14:00","23:30"], "N308A": ["14:30","22:30"], "N309A": ["14:30","23:30"], "N30XA": ["14:30","00:30"], "O008A": ["15:00","23:00"], "O308A": ["15:30","23:30"], "O309A": ["15:30","00:30"], "O309G": ["15:30","00:45"], "O30XA": ["15:30","01:30"], "TRN": ["08:30","17:30"] };
    const OFF_LIST = ['AL', 'D1', 'D2', 'D2A', 'D3', 'D3X', 'LEV', 'ä¼‘', ''];
    let state = { master: {}, personal: {}, orig: {}, simPrefix: {}, year: 2026, month: 0, userName: "", targetId: "A022994", selectedDays: [] };

    function getTime(s) { if (!s) return null; const key = s.toUpperCase().split('/')[0]; return SHIFT_DB[key] || null; }
    function isOff(s) { return !s || OFF_LIST.includes(s.toUpperCase()) || !getTime(s); }
    function getRest(pre, nxt) { 
        const p = getTime(pre), n = getTime(nxt); if (!p || !n) return 24; 
        const [pH, pM] = p[1].split(':').map(Number), [nH, nM] = n[0].split(':').map(Number); 
        return ((nH + 24) * 60 + nM - (pH * 60 + pM)) / 60; 
    }
    function checkLegality(schedule, d) {
        const rPre = getRest(schedule[d-1], schedule[d]), rNxt = getRest(schedule[d], schedule[d+1]);
        let streak = 0;
        for (let i = d; i >= 1; i--) { if (!isOff(schedule[i])) streak++; else break; }
        for (let i = d + 1; i <= 31; i++) { if (!isOff(schedule[i])) streak++; else break; }
        return { restErr: rPre < 11 || rNxt < 11, streakErr: streak > 6, rVal: Math.min(rPre, rNxt), sVal: streak };
    }

    // æ‰¹é‡é¸å–é‚è¼¯
    function toggleDay(d) {
        const idx = state.selectedDays.indexOf(d);
        if (idx > -1) state.selectedDays.splice(idx, 1);
        else state.selectedDays.push(d);
        state.selectedDays.sort((a,b)=>a-b);
        updateBatchBar();
        render();
    }

    function updateBatchBar() {
        const bar = document.getElementById('batchBar');
        if (state.selectedDays.length > 0) {
            bar.style.display = 'flex';
            document.getElementById('selectedDaysTxt').innerText = state.selectedDays.join(', ');
            // å‹•æ…‹ç”Ÿæˆæ‰¹é‡ç­åˆ¥é¸é …
            let commonPrefixes = new Set();
            state.selectedDays.forEach(d => {
                if(state.master[d]) Object.keys(state.master[d]).forEach(p => commonPrefixes.add(p));
            });
            let html = '<option value="">é¸æ“‡ç­åˆ¥...</option>';
            Array.from(commonPrefixes).sort().forEach(p => html += `<option value="${p}">${p} ç­</option>`);
            document.getElementById('batchShift').innerHTML = html;
        } else {
            bar.style.display = 'none';
        }
    }

    function applyBatch() {
        const prefix = document.getElementById('batchShift').value;
        if (!prefix) return;
        state.selectedDays.forEach(d => state.simPrefix[d] = prefix);
        clearSelection();
    }

    function clearSelection() {
        state.selectedDays = [];
        updateBatchBar();
        render();
    }

    // è³‡æ–™è™•ç†éƒ¨åˆ† (åŒå‰)
    document.getElementById('uploadAll').onchange = function(e) {
        const file = e.target.files[0]; if (!file) return;
        state.targetId = document.getElementById('empId').value.trim().toUpperCase();
        const reader = new FileReader();
        reader.onload = (ev) => {
            const sheet = XLSX.read(new Uint8Array(ev.target.result), {type:'array'}).Sheets;
            const rows = XLSX.utils.sheet_to_json(sheet[Object.keys(sheet)[0]], {header:1, defval:""});
            const ym = String(rows[4][0]).match(/\d+/g); state.year = ym[0]; state.month = ym[1]-1;
            let dCols = {}; rows[5].forEach((c, i) => { if(!isNaN(parseInt(c))) dCols[parseInt(c)] = i; });
            state.master = {}; state.personal = {};
            rows.forEach(r => {
                const id = String(r[3]).trim().toUpperCase(), name = r[2];
                if (!id || !name) return;
                state.personal[name] = { id: id };
                for(let d=1; d<=31; d++) {
                    let s = (r[dCols[d]] || "").trim();
                    state.personal[name][d] = s;
                    if(s && isNaN(s)) {
                        const p = s.charAt(0).toUpperCase();
                        if(!state.master[d]) state.master[d] = {};
                        if(!state.master[d][p]) state.master[d][p] = [];
                        state.master[d][p].push({ name, actual: s });
                    }
                }
            });
            run();
        };
        reader.readAsArrayBuffer(file);
    };

    function run() {
        let entry = Object.values(state.personal).find(p => p.id === state.targetId);
        if(!entry) return alert("æŸ¥ç„¡å·¥è™Ÿ");
        state.userName = Object.keys(state.personal).find(k => state.personal[k].id === state.targetId);
        for(let d=1; d<=31; d++) { state.orig[d] = entry[d] || ""; state.simPrefix[d] = state.orig[d].charAt(0); }
        render();
    }

    function render() {
        const last = new Date(state.year, state.month + 1, 0).getDate();
        let html = "";
        for(let d=1; d<=last; d++) {
            const isSelected = state.selectedDays.includes(d);
            const res = checkLegality({...state.orig}, d);
            html += `<div class="day-card ${isSelected?'selected':''}">
                <div class="date-header" onclick="toggleDay(${d})">
                    <div><span class="date-num">${d}</span> <span class="orig-tag">åŸ:${state.orig[d]||'ä¼‘'}</span></div>
                    <span class="select-hint">${isSelected?'å·²é¸å–':'é»æ“Šå¤šé¸'}</span>
                </div>
                <select class="shift-select" onchange="state.simPrefix[${d}]=this.value; render();">
                    <option value="">ä¼‘</option>
                    ${state.master[d] ? Object.keys(state.master[d]).sort().map(p => `<option value="${p}" ${p===state.simPrefix[d]?'selected':''}>${p} ç­</option>`).join('') : ''}
                </select>
                <div class="names-list">${getSwapList(d, state.simPrefix[d])}</div>
            </div>`;
        }
        document.getElementById('calendarArea').innerHTML = html;
    }

    function getSwapList(day, prefix) {
        if(!prefix || !state.master[day] || !state.master[day][prefix]) return "";
        
        // æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—æ•´æ‰¹ç¬¦åˆçš„äºº
        const isBatchDay = state.selectedDays.includes(day);
        const candidates = state.master[day][prefix].map(item => {
            if(item.name === state.userName) return null;
            
            let oSched = {...state.personal[item.name]};
            oSched[day] = state.orig[day];
            const res = checkLegality(oSched, day);
            
            // æª¢æŸ¥æ˜¯å¦ã€Œæ•´æ‰¹ã€éƒ½ç¬¦åˆ
            let isFullBatchMatch = false;
            if (isBatchDay && state.selectedDays.length > 1) {
                isFullBatchMatch = state.selectedDays.every(bd => {
                    const hasPrefix = state.personal[item.name][bd]?.startsWith(prefix);
                    let tempSched = {...state.personal[item.name]};
                    state.selectedDays.forEach(sbd => tempSched[sbd] = state.orig[sbd]);
                    const bRes = checkLegality(tempSched, bd);
                    return hasPrefix && !bRes.restErr && !bRes.streakErr;
                });
            }

            return { ...item, res, isFullBatchMatch };
        }).filter(Boolean);

        // æ’åºï¼šæ•´æ‰¹ç¬¦åˆè€…æ’æœ€å‰é¢
        candidates.sort((a, b) => (b.isFullBatchMatch ? 1 : 0) - (a.isFullBatchMatch ? 1 : 0));

        return candidates.map(c => `
            <div class="person-card ${!c.res.restErr && !c.res.streakErr ? 'can-swap' : 'cannot-swap'} ${c.isFullBatchMatch ? 'batch-hero' : ''}">
                <div class="card-row">
                    <span class="name-txt">${c.isFullBatchMatch ? 'ğŸŒŸ ' : ''}${c.name}</span>
                    <span class="actual-shift-txt">${c.actual}</span>
                </div>
                ${c.isFullBatchMatch ? '<span style="color:var(--safe); font-size:10px; font-weight:bold;">âœ¨ é€™å¹¾å¤©ä»–éƒ½å¯ä»¥æ›ï¼</span>' : ''}
            </div>
        `).join('');
    }
</script>
</body>
</html>
