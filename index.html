<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­è¡¨æ¨¡æ“¬å™¨ - èº«åˆ†æ’é™¤å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007AFF; --danger: #ff4d4f; --safe: #2e7d32; --bg: #f0f2f5; --selected: #fff9c4; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); font-size: 14px; }
        .config-box { background: #fff; padding: 12px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; }
        .row-group { display: flex; gap: 8px; align-items: center; }
        .file-input-wrapper { background: #f8f9fa; padding: 8px; border-radius: 8px; border: 1px dashed #ccc; flex: 1; font-size: 12px; }
        input[type="text"] { width: 100px; padding: 8px; border: 1px solid #ccc; border-radius: 8px; text-align: center; font-weight: bold; }
        button { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        #calendar-container { padding: 10px; }
        .day-card { background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .shift-select { width: 100%; padding: 8px; border: 2px solid var(--primary); border-radius: 6px; font-size: 16px; text-align: center; margin: 8px 0; }
        
        .person-card { padding: 8px; border-radius: 6px; margin-top: 5px; font-size: 12px; background: #f9f9f9; border-left: 4px solid #ccc; }
        .can-swap { border-left-color: var(--safe); background: #f6ffed; }
        .forbidden { border-left-color: #d9d9d9; opacity: 0.5; background: #fafafa; } /* æ’é™¤ç‰¹å®šé¡è‰² */

        .status-badge { font-size: 10px; padding: 1px 4px; border-radius: 4px; margin-left: 5px; }
        .badge-yellow { background: #ffeb3b; color: #000; }
        .badge-pink { background: #f48fb1; color: #fff; }
        .badge-blue { background: #1e88e5; color: #fff; }
        .badge-safe { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    </style>
</head>
<body>

<div class="config-box">
    <div class="row-group">
        <div class="file-input-wrapper"><input type="file" id="uploadAll" accept=".xlsx"></div>
        <input type="text" id="empId" value="A022994" placeholder="å·¥è™Ÿ">
        <button onclick="run()" style="background: var(--safe);">è®€å–é¡è‰²èº«åˆ†</button>
    </div>
</div>

<div id="calendar-container">
    <div id="displayUser" style="padding: 10px; font-weight: bold;">è«‹è®€å– .xlsx æª”æ¡ˆ</div>
    <div id="calendarArea"></div>
</div>

<script>
    let state = { master: {}, personal: {}, orig: {}, simPrefix: {}, dayKeys: [], collapsedDays: {} };

    // æ ¸å¿ƒé¡è‰²é‚è¼¯ï¼šå°‡é¡è‰²åˆ†é¡
    function analyzeColor(cell) {
        if (!cell || !cell.s || !cell.s.fill || !cell.s.fill.fgColor) return { type: 'SAFE', label: 'ç„¡è‰²' };
        let hex = cell.s.fill.fgColor.rgb || "";
        if (hex.length > 6) hex = hex.substring(hex.length - 6); // å–å¾Œ6ç¢¼

        // å®šç¾©ç¦å€è‰²è™Ÿï¼ˆæ ¹æ“šæè¿°ï¼‰
        const yellowTones = ['FFFF00', 'FFFFE0', 'F2F200']; 
        const pinkTones = ['FFC0CB', 'FF00FF', 'FF69B4', 'F48FB1'];
        const blueTones = ['0000FF', '00008B', 'ADD8E6', '87CEEB', '1E88E5'];

        if (yellowTones.includes(hex.toUpperCase())) return { type: 'FORBIDDEN', label: 'å‰¯ç«™(é»ƒ)', class: 'badge-yellow' };
        if (pinkTones.some(t => hex.toUpperCase().includes(t))) return { type: 'FORBIDDEN', label: 'ç£å°(ç²‰)', class: 'badge-pink' };
        if (blueTones.some(t => hex.toUpperCase().includes(t))) return { type: 'FORBIDDEN', label: 'TAO(è—)', class: 'badge-blue' };
        
        return { type: 'SAFE', label: 'å¯ä¸Š(ä»–è‰²)', class: 'badge-safe' };
    }

    document.getElementById('uploadAll').onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = new Uint8Array(ev.target.result);
            // å¿…é ˆé–‹å•Ÿ cellStyles: true æ‰èƒ½è®€åˆ°é¡è‰²
            const workbook = XLSX.read(data, {type:'array', cellStyles: true});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:""});
            
            let headerIdx = rows.findIndex(r => r.includes("å“¡å·¥ç·¨è™Ÿ"));
            const headerRow = rows[headerIdx];
            
            state.dayKeys = [];
            headerRow.forEach(cell => { if(String(cell).includes("/")) state.dayKeys.push(cell); });

            state.personal = {}; state.master = {};
            for(let i = headerIdx + 1; i < rows.length; i++) {
                const id = String(rows[i][1]||"").trim().toUpperCase();
                const name = String(rows[i][2]||"").trim();
                if(!id || id.includes("ç¸½è¨ˆ")) continue;

                state.personal[name] = { id: id };
                state.dayKeys.forEach(d => {
                    const colIdx = headerRow.indexOf(d);
                    const cellAddr = XLSX.utils.encode_cell({r: i, c: colIdx});
                    const cell = sheet[cellAddr];
                    const shiftText = cell ? String(cell.v).trim() : "";
                    const colorInfo = analyzeColor(cell);

                    state.personal[name][d] = { text: shiftText, color: colorInfo };
                    
                    const prefix = shiftText.charAt(0).toUpperCase() || "D";
                    if(!state.master[d]) state.master[d] = {};
                    if(!state.master[d][prefix]) state.master[d][prefix] = [];
                    state.master[d][prefix].push({ name, actual: shiftText, color: colorInfo });
                });
            }
            run();
        };
        reader.readAsArrayBuffer(file);
    };

    function run() {
        const id = document.getElementById('empId').value.trim().toUpperCase();
        const userName = Object.keys(state.personal).find(k => state.personal[k].id === id);
        if(!userName) return;
        state.userName = userName;
        document.getElementById('displayUser').innerText = `ğŸ‘¤ ${userName} (${id}) - é¡è‰²åˆ†ææ¨¡å¼`;
        state.dayKeys.forEach(d => {
            state.orig[d] = state.personal[userName][d];
            state.simPrefix[d] = state.orig[d].text.charAt(0).toUpperCase() || "D";
            state.collapsedDays[d] = true;
        });
        render();
    }

    function render() {
        const area = document.getElementById('calendarArea');
        let html = '';
        state.dayKeys.forEach(d => {
            const currentPrefix = state.simPrefix[d];
            const isOriginal = (currentPrefix === (state.orig[d].text.charAt(0).toUpperCase() || "D"));
            const candidates = (state.master[d] && state.master[d][currentPrefix]) 
                               ? state.master[d][currentPrefix].filter(c => c.name !== state.userName) : [];

            html += `
                <div class="day-card">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>${d}</span>
                        <span style="font-size:11px; color:#888;">åŸï¼š${state.orig[d].text}</span>
                    </div>
                    <select class="shift-select" onchange="state.simPrefix['${d}']=this.value; state.collapsedDays['${d}']=false; render();">
                        <option value="D" ${currentPrefix==='D'?'selected':''}>ä¼‘å‡</option>
                        ${Object.keys(state.master[d]||{}).sort().map(p => p==='D'?'':`<option value="${p}" ${p===currentPrefix?'selected':''}>${p} ç­</option>`).join('')}
                    </select>
                    <div>
                        ${candidates.map(c => {
                            const isForbidden = (c.color.type === 'FORBIDDEN');
                            return `
                                <div class="person-card ${isForbidden ? 'forbidden' : 'can-swap'}">
                                    <b>${c.name}</b> <small>${c.actual}</small>
                                    <span class="status-badge ${c.color.class || ''}">${c.color.label}</span>
                                    ${isForbidden ? '<span style="float:right; font-size:10px; color:#999;">âœ• ä¸å¯ä»£</span>' : '<span style="float:right; color:var(--safe);">ğŸ¯ å¯æ›</span>'}
                                </div>`;
                        }).join('')}
                    </div>
                </div>`;
        });
        area.innerHTML = html;
    }
</script>
</body>
</html>
