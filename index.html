<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­è¡¨æ¨¡æ“¬å™¨ - v3.4 - 20260120</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        :root { --primary: #007AFF; --danger: #ff4d4f; --safe: #2e7d32; --bg: #f0f2f5; --selected: #fff9c4; --gold: #d4a017; --white: #ffffff; }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); font-size: 14px; padding-bottom: 150px; /* é ç•™åº•éƒ¨ç©ºé–“çµ¦æ‡¸æµ®é¢æ¿ */ }
        
        /* é ‚éƒ¨å›ºå®šé…ç½® */
        .config-box { background: var(--white); padding: 12px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .row-group { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
        .version-tag { font-size: 10px; color: #999; margin-left: auto; }

        /* æ»‘å‹•é–‹é—œ */
        .switch-container { display: flex; align-items: center; gap: 8px; background: #eee; padding: 4px; border-radius: 20px; cursor: pointer; position: relative; width: 80px; height: 32px; user-select: none; }
        .switch-label { flex: 1; text-align: center; z-index: 2; font-size: 14px; transition: 0.3s; }
        .switch-slider { position: absolute; width: 36px; height: 26px; background: var(--white); border-radius: 18px; top: 3px; left: 3px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .mode-mobile .switch-slider { left: 41px; }

        /* æ—¥æ›†å€åŸŸä½ˆå±€ */
        #calendarArea { display: grid; gap: 8px; padding: 8px; }
        .mode-pc { grid-template-columns: repeat(7, 1fr); }
        .mode-mobile { grid-template-columns: 1fr; }

        .day-card { background: var(--white); border-radius: 10px; padding: 10px; border: 2px solid transparent; min-height: 80px; transition: 0.2s; cursor: pointer; }
        .day-card.selected { border-color: var(--gold); background: var(--selected); }
        .date-label { display: flex; justify-content: space-between; font-weight: 800; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .person-item { padding: 6px 8px; border-radius: 4px; margin-top: 4px; font-size: 12px; border-left: 3px solid #ccc; background: #f9f9f9; display: flex; flex-direction: column; }
        .perfect-match { border-left-color: var(--gold); background: #fffdf0; font-weight: bold; border-left-width: 5px; cursor: pointer; }
        .perfect-match.target-selected { background: #fff3cd; border: 2px solid var(--gold); box-shadow: 0 0 8px rgba(212, 160, 23, 0.3); }
        
        .btn-collapse { width: 100%; border: none; background: #eee; color: #666; font-size: 10px; padding: 8px; border-radius: 4px; cursor: pointer; margin-top: 8px; }
        .error-tag { font-size: 9px; background: #fff1f0; color: #cf1322; padding: 1px 4px; border-radius: 3px; border: 1px solid #ffa39e; margin-right: 2px; display: inline-block; margin-top: 2px; }
        .colored-name { font-weight: 900; text-shadow: 0.3px 0.3px 0.5px rgba(0,0,0,0.1); }
        
        /* ğŸš€ æ”¹è‰¯ï¼šæ‡¸æµ®å°èª¿é¢æ¿ */
        .batch-panel { 
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 95%; 
            max-width: 500px; 
            background: rgba(255, 251, 230, 0.95); 
            backdrop-filter: blur(10px);
            padding: 15px; 
            border-radius: 16px; 
            border: 2px solid #ffe58f; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15); 
            z-index: 2000; 
            display: none; 
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { bottom: -100px; opacity: 0; } to { bottom: 20px; opacity: 1; } }

        .btn-execute { background: var(--danger); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 900; font-size: 16px; cursor: pointer; width: 100%; margin-top: 10px; }
    </style>
</head>
<body class="mode-pc">

<div class="config-box">
    <div class="row-group">
        <strong style="color:var(--primary)">ç­è¡¨æ¨¡æ“¬å™¨</strong>
        <div class="switch-container" onclick="toggleMode()">
            <div class="switch-slider"></div>
            <div class="switch-label pc-label">ğŸ’»</div>
            <div class="switch-label mb-label">ğŸ“±</div>
        </div>
        <span class="version-tag">v3.4 - 20260120</span>
    </div>
    <div class="row-group">
        <input type="file" id="xlsxIn" accept=".xlsx" style="flex:1; min-width:150px;">
        <input type="text" id="targetId" value="A022994" placeholder="å“¡å·¥ç·¨è™Ÿ" style="width:90px; text-align:center; padding:5px; border:1px solid #ccc; border-radius:4px;">
        <button onclick="initData()" id="btnAnalyze" style="background:var(--safe); color:white; border:none; padding:8px 15px; border-radius:8px; font-weight:bold;">åˆ†æç­è¡¨</button>
    </div>
</div>

<div id="batchPanel" class="batch-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #ffe58f; padding-bottom: 8px; margin-bottom: 8px;">
        <span style="font-weight:bold; color:#856404;">ğŸ“… å·²é¸ï¼š<span id="selText">0</span> å¤©</span>
        <button onclick="closePanel()" style="background:none; border:none; color:#999; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <div id="selectedTargetDisplay" style="font-weight:bold; color:var(--danger); margin-bottom: 8px;">å°è±¡ï¼šå°šæœªé¸æ“‡ (é»æ“Šâœ¨)</div>
    <div style="display:flex; align-items:center; gap:8px;">
        <span style="white-space:nowrap;">ç›®æ¨™ç­åˆ¥ï¼š</span>
        <select id="shiftSel" onchange="renderUI()" style="padding:8px; flex:1; border-radius:8px; border:2px solid var(--primary); font-size:14px;"></select>
    </div>
    <button class="btn-execute" onclick="executeBatch()">åŸ·è¡Œæ‰¹æ¬¡å°èª¿</button>
</div>

<div id="calendarArea" class="mode-pc"></div>

<script>
    // --- æ ¸å¿ƒé‚è¼¯ç¹¼æ‰¿ v3.3 ---
    const TIME_TABLE = { "E159G": ["05:15","14:45"], "F30XA": ["06:30","16:30"], "G009A": ["07:00","16:00"], "J00XA": ["10:00","20:00"], "N008A": ["14:00","22:00"], "N30XA": ["14:30","00:30"], "O30XA": ["15:30","01:30"], "D1": ["09:00","18:00"] };
    const EXCLUDE_COLORS = ["FFFF99", "FF99CC", "99CCFF", "CCFFFF"];
    let state = { master: {}, personal: {}, dayKeys: [], selectedDays: [], mode: 'pc', expanded: {}, targetPrefix: "", chosenTarget: null };

    window.onload = function() {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        setMode(isMobile ? 'mobile' : 'pc');
    };

    function toggleMode() { setMode(state.mode === 'pc' ? 'mobile' : 'pc'); }
    function setMode(m) {
        state.mode = m;
        document.body.className = `mode-${m}`;
        document.getElementById('calendarArea').className = `mode-${m}`;
        renderUI();
    }

    // é—œé–‰é¢æ¿ä¸¦æ¸…é™¤é¸æ“‡
    function closePanel() {
        state.selectedDays = [];
        state.chosenTarget = null;
        document.getElementById('batchPanel').style.display = 'none';
        renderUI();
    }

    function getCellVal(cell) {
        if (!cell || cell.value === null || cell.value === undefined) return "";
        if (typeof cell.value === 'object') return cell.text || (cell.value.result ? String(cell.value.result) : "");
        return String(cell.value).trim();
    }

    async function initData() {
        const f = document.getElementById('xlsxIn').files[0];
        if(!f) return;
        try {
            document.getElementById('btnAnalyze').innerText = "â³...";
            const workbook = new ExcelJS.Workbook();
            const arrayBuffer = await f.arrayBuffer();
            await workbook.xlsx.load(arrayBuffer);
            const worksheet = workbook.getWorksheet(1);
            state.personal = {}; state.master = {}; state.dayKeys = []; state.expanded = {}; state.selectedDays = []; state.chosenTarget = null;

            let headerRowIdx = -1;
            worksheet.eachRow((row, rowNum) => { if (headerRowIdx !== -1) return; row.eachCell(c => { if (getCellVal(c).includes("å“¡å·¥ç·¨è™Ÿ")) headerRowIdx = rowNum; }); });
            if (headerRowIdx === -1) throw new Error("æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—");

            const headerRow = worksheet.getRow(headerRowIdx);
            headerRow.eachCell((cell, colNum) => {
                const val = getCellVal(cell);
                if (val.includes("/")) state.dayKeys.push({ label: val, col: colNum });
            });

            worksheet.eachRow((row, rowNum) => {
                if (rowNum <= headerRowIdx) return;
                const id = getCellVal(row.getCell(2)).toUpperCase();
                const name = getCellVal(row.getCell(3));
                if (!id || id.includes("ç¸½è¨ˆ")) return;
                state.personal[name] = { id, schedule: {} };
                state.dayKeys.forEach(dk => {
                    const cell = row.getCell(dk.col);
                    let val = getCellVal(cell) || "D1";
                    let hex = null;
                    if (cell.fill && cell.fill.type === 'pattern' && cell.fill.fgColor && cell.fill.fgColor.argb) {
                        const rawHex = cell.fill.fgColor.argb.toUpperCase();
                        if (rawHex !== "FFFFFFFF" && rawHex !== "00000000") hex = rawHex.slice(-6);
                    }
                    state.personal[name].schedule[dk.label] = { text: val, hex: hex, isForb: hex ? EXCLUDE_COLORS.includes(hex) : false };
                    const p = val.charAt(0).toUpperCase();
                    if(!state.master[dk.label]) state.master[dk.label] = {};
                    if(!state.master[dk.label][p]) state.master[dk.label][p] = [];
                    state.master[dk.label][p].push({ name, text: val });
                });
            });
            document.getElementById('btnAnalyze').innerText = "åˆ†æå®Œæˆ";
            renderUI();
        } catch (err) { alert("å¤±æ•—ï¼š" + err.message); document.getElementById('btnAnalyze').innerText = "åˆ†æå¤±æ•—"; }
    }

    function toM(t) { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; }
    function checkSafe(pre, cur, nxt) {
        const p = TIME_TABLE[pre?.split('/')[0]], c = TIME_TABLE[cur?.split('/')[0]], n = TIME_TABLE[nxt?.split('/')[0]];
        if(!c) return true;
        let ok = true;
        if(p) ok = ok && ((toM(c[0]) + 1440) - toM(p[1])) >= 660; 
        if(n) ok = ok && ((toM(n[0]) + 1440) - toM(c[1])) >= 660;
        return ok;
    }

    function toggleSelect(d) {
        const dayLabels = state.dayKeys.map(k => k.label);
        const currentIdx = dayLabels.indexOf(d);
        if (state.selectedDays.length > 0) {
            const indices = state.selectedDays.map(day => dayLabels.indexOf(day)).sort((a,b)=>a-b);
            const minIdx = indices[0], maxIdx = indices[indices.length - 1];
            if (state.selectedDays.includes(d)) state.selectedDays.splice(state.selectedDays.indexOf(d), 1);
            else if (currentIdx === minIdx - 1 || currentIdx === maxIdx + 1) state.selectedDays.push(d);
            else state.selectedDays = [d];
        } else state.selectedDays.push(d);
        
        state.chosenTarget = null;
        const bp = document.getElementById('batchPanel');
        if(state.selectedDays.length > 0) {
            bp.style.display = 'block';
            document.getElementById('selText').innerText = state.selectedDays.length;
            document.getElementById('selectedTargetDisplay').innerText = `å°è±¡ï¼šå°šæœªé¸æ“‡ (é»æ“Šâœ¨)`;
            let sets = new Set();
            state.selectedDays.forEach(day => Object.keys(state.master[day]||{}).forEach(p => sets.add(p)));
            let opt = '<option value="">(åˆå§‹) é¡¯ç¤ºåŒç­åˆ¥åå–®</option>';
            Array.from(sets).sort().forEach(p => opt += `<option value="${p}">${p} ç­</option>`);
            document.getElementById('shiftSel').innerHTML = opt;
        } else bp.style.display = 'none';
        renderUI();
    }

    function selectTargetPerson(name) {
        state.chosenTarget = name;
        document.getElementById('selectedTargetDisplay').innerText = `å°è±¡ï¼š${name}`;
        renderUI();
    }

    function toggleExpand(e, d) { e.stopPropagation(); state.expanded[d] = !state.expanded[d]; renderUI(); }

    function executeBatch() {
        const me = Object.keys(state.personal).find(n => state.personal[n].id === document.getElementById('targetId').value.toUpperCase());
        if(!state.chosenTarget) return alert("è«‹å…ˆå¾ä¸‹æ–¹æ¸…å–®ä¸­é»æ“Šé¸å–ä¸€ä½å°è±¡ï¼ˆæ¨™è¨» âœ¨ çš„äººï¼‰ã€‚");
        if(confirm(`ç¢ºå®šè¦å°‡å·²é¸æ—¥æœŸèˆ‡ ${state.chosenTarget} å°èª¿å—ï¼Ÿ`)) {
            state.selectedDays.forEach(d => {
                const myS = state.personal[me].schedule[d].text, hS = state.personal[state.chosenTarget].schedule[d].text;
                state.personal[me].schedule[d].text = hS; state.personal[state.chosenTarget].schedule[d].text = myS;
            });
            alert(`å°èª¿æˆåŠŸï¼`);
            closePanel();
        }
    }

    function renderUI() {
        const area = document.getElementById('calendarArea');
        const dayLabels = state.dayKeys.map(k => k.label);
        const myName = Object.keys(state.personal).find(n => state.personal[n].id === document.getElementById('targetId').value.toUpperCase());
        if(!myName || dayLabels.length === 0) return;
        
        state.targetPrefix = document.getElementById('shiftSel')?.value || "";
        const selectedIndices = state.selectedDays.map(d => dayLabels.indexOf(d)).sort((a,b)=>a-b);
        const firstIdx = selectedIndices[0], lastIdx = selectedIndices[selectedIndices.length - 1];

        let userStats = {};
        if(state.selectedDays.length > 0) {
            Object.keys(state.personal).forEach(n => {
                if(n === myName) return;
                userStats[n] = { errors: [], totalMatch: 0 };
                state.selectedDays.forEach(d => {
                    const myS = state.personal[myName].schedule[d], cS = state.personal[n].schedule[d];
                    const dIdx = dayLabels.indexOf(d), target = state.targetPrefix || myS.text.charAt(0).toUpperCase();
                    const isMatchPrefix = cS.text.charAt(0).toUpperCase() === target;
                    let safe = checkSafe(state.personal[n].schedule[dayLabels[dIdx-1]]?.text, myS.text, state.personal[n].schedule[dayLabels[dIdx+1]]?.text);
                    if (dIdx === firstIdx) safe = safe && checkSafe(state.personal[n].schedule[dayLabels[dIdx-1]]?.text, myS.text, null);
                    if (dIdx === lastIdx) safe = safe && checkSafe(null, myS.text, state.personal[n].schedule[dayLabels[dIdx+1]]?.text);
                    if (isMatchPrefix && !cS.isForb && safe) userStats[n].totalMatch++;
                    else {
                        let r = !isMatchPrefix ? "ä¸ç¬¦" : (cS.isForb ? "èº«åˆ†" : "ä¼‘è¶³");
                        userStats[n].errors.push(`${d.split('/')[1]}æ—¥${r}`);
                    }
                });
            });
        }
        const commonIntersection = Object.keys(userStats).filter(n => userStats[n].totalMatch === state.selectedDays.length);

        area.innerHTML = dayLabels.map(d => {
            const isSelectedDay = state.selectedDays.includes(d), isExp = !!state.expanded[d], myS = state.personal[myName].schedule[d];
            const currT = state.targetPrefix || myS.text.charAt(0).toUpperCase();
            let topHTML = "", otherHTML = "", otherCount = 0;

            Object.keys(state.personal).forEach(n => {
                if(n === myName) return;
                const cS = state.personal[n].schedule[d], isTop = isSelectedDay && commonIntersection.includes(n), isMatchPrefix = cS.text.charAt(0).toUpperCase() === currT;
                if (isTop || isMatchPrefix) {
                    const col = cS.hex ? `#${cS.hex}` : '#000000';
                    const isChosen = state.chosenTarget === n;
                    if(isTop) {
                        topHTML += `<div class="person-item perfect-match ${isChosen?'target-selected':''}" onclick="event.stopPropagation(); selectTargetPerson('${n}')">
                            <div style="display:flex;justify-content:space-between;width:100%;align-items:center;">
                                <span class="colored-name" style="color:${col}">${n} <small style="color:#666">(${cS.text})</small></span>
                                <b>âœ¨</b>
                            </div>
                        </div>`;
                    } else { 
                        otherCount++; 
                        if(isExp) {
                            let errTags = isSelectedDay ? userStats[n].errors.map(e => `<span class="error-tag">${e}</span>`).join('') : '';
                            otherHTML += `<div class="person-item"><div style="display:flex;justify-content:space-between;width:100%;align-items:center;"><span class="colored-name" style="color:${col}">${n} <small style="color:#666">(${cS.text})</small></span></div><div>${errTags}</div></div>`;
                        }
                    }
                }
            });
            return `<div class="day-card ${isSelectedDay?'selected':''}" onclick="toggleSelect('${d}')">
                <div class="date-label">${d.split('/')[1]}æ—¥<span>${myS.text}</span></div>
                <div style="margin-top:5px;">${topHTML}
                    <button class="btn-collapse" onclick="toggleExpand(event, '${d}')">${isExp ? 'æ”¶èµ·' : `å…¶ä»–(${otherCount})`}</button>
                    <div style="margin-top:4px;">${otherHTML}</div>
                </div>
            </div>`;
        }).join('');
    }
</script>
</body>
</html>
